```{r estimation_libraries}

library(tidyverse)

library(here)

library(stargazer)

devtools::load_all()

```

# Import and process data

```{r import_data}

rmarkdown::render(here("vignettes","Import_Data.Rmd"),)

```


```{r process_data}

rmarkdown::render(here("vignettes","Process_Data.Rmd"))

```

# Make country list

```{r set_countries_list}

countries_list = list(
  oecd_countries = c(
    "Australia",
    "Austria",
    "Belgium",
    "Canada",
    "Chile",
    "Colombia",
    "Costa_Rica",
    "Czech_Republic",
    "Denmark",
    "Estonia",
    "Finland",
    "France",
    "Germany",
    "Greece",
    "Hungary",
    "Iceland",
    "Ireland",
    "Israel",
    "Italy",
    "Japan",
    "Korea",
    "Latvia",
    "Lithuania",
    "Luxembourg",
    "Mexico",
    "Netherlands",
    "New_Zealand",
    "Norway",
    "Poland",
    "Portugal",
    "Slovak_Republic",
    "Slovenia",
    "Spain",
    "Sweden",
    "Switzerland",
    "Turkey",
    "United_Kingdom"
    ,
    "United_States"
  ),
  kpp_countries = c(
    "Australia",
    "Austria",
    "Belgium",
    "Canada",
    "Switzerland",
    "Germany",
    "Denmark",
    "Spain",
    "Finland",
    "France",
    "United_Kingdom",
    "Ireland",
    "Italy",
    "Japan",
    "Netherlands",
    "Portugal",
    "Sweden",
    "United_States"
  ),
  fsap_countries = c(
    "Austria",
    "Belgium",
    "Germany",
    "Denmark",
    "Spain",
    "France",
    "Finland",
    "Greece",
    "Ireland",
    "Italy",
    "Luxembourg",
    "Netherlands",
    "Portugal",
    "Sweden",
    "United_Kingdom"
  ),
  eu_countries = c(
    "Austria",
    "Belgium",
    "Bulgaria",
    "Croatia",
    "Cyprus",
    "Czech_Republic",
    "Denmark",
    "Estonia",
    "Finland",
    "France",
    "Germany",
    "Greece",
    "Hungary",
    "Ireland",
    "Italy",
    "Latvia",
    "Lithuania",
    "Luxembourg",
    "Malta",
    "Netherlands",
    "Poland",
    "Portugal",
    "Romania",
    "Slovak_Republic",
    "Slovenia",
    "Spain",
    "Sweden",
    "United_Kingdom"
  ),
  euro_countries = c(
    "Austria",
    "Belgium",
    "Cyprus",
    "Estonia",
    "Finland",
    "France",
    "Germany",
    "Greece",
    "Ireland",
    "Italy",
    "Latvia",
    "Lithuania",
    "Luxembourg",
    "Malta",
    "Netherlands",
    "Portugal",
    "Slovak_Republic",
    "Slovenia",
    "Spain"
  )
)

countries_list = map(countries_list, function(temp_list){
  
  list = temp_list %>% 
    str_replace_all(., "Turkey","Turkiye") %>% 
    str_replace(., "Czech_Republic", "Czechia") %>% 
    str_replace(., "Slovak_Republic", "Slovakia")
  
  
  
  
})


country_pair_list = map(countries_list, function(temp_list){
  
  temp_df = temp_list %>% 
    as_tibble() %>% 
    expand(a = value, b = value) %>% 
    filter(!a == b) %>% 
    mutate(country_pair = paste_country_pair(a,b)) %>% 
    select(country_pair) %>% 
    distinct()
  
  
  return(temp_df)
  
  
  
})

```



```{r define_reg_formula_list}

control_vars = c("trade_gdp","fx_stab","fo_ind","gdp_usd")


reg_formula_list = list(
  fd_spec = paste(
    "fin_synch_diff ~ lag(bank_gdp,1) * crisis_ind",
    "lag(bank_gdp,1) * fd_ind",
    paste(control_vars,
          collapse = "+"),
    sep = "+"
  ),
  euro_spec = paste(
    "fin_synch_diff ~ lag(bank_gdp,1) * crisis_ind",
    "lag(bank_gdp,1) * euro_member",
    paste(control_vars,
          collapse = "+"),
    sep = "+"
  ),
  total_spec = paste(
    "fin_synch_diff ~ lag(bank_gdp,1) * crisis_ind",
    "lag(bank_gdp,1) * fd_ind",
    "lag(bank_gdp,1) * euro_member",
    paste(control_vars,
          collapse = "+"),
    sep = "+"
  )
)

rm(control_vars)

# Add  trend

trend_formula_list = map(reg_formula_list, function(temp_formula){
  
  new_formula = paste(temp_formula, "time_trend", sep = "+")
  
  
}) %>% 
  reduce(c)

names(trend_formula_list) = paste0(names(reg_formula_list), "_trend")



# Merge formula

reg_formula_list = c(reg_formula_list, trend_formula_list)

rm(trend_formula_list)


```


# Estimation

```{r estimation}


reg_list = map(reg_formula_list, function(temp_list){
  
  temp_formula = temp_list
  
  temp_model = plm(formula = temp_formula,
                   data = country_pair_df,
          model = "within",effect = "twoways",
          index = c("country_pair","year"))

  return(temp_model)
  
})


```

```{r plot_results}

extract_coeffs = function(temp_reg_obj, temp_name){
  
  temp_coeffs = coefficients(temp_reg_obj)
  
  temp_se = sqrt(diag(plm::vcovHC(temp_reg_obj,cluster = "group")))
  
  if(!length(temp_coeffs) == length(temp_se)){browser()}
  
  temp_significance = abs(temp_coeffs / temp_se)
  
  temp_sign = sign(temp_coeffs)
  
  temp_ind = names(temp_coeffs) %in% c("lag(bank_gdp, 1)",
                                      "lag(bank_gdp, 1):crisis_ind",
                                      "lag(bank_gdp, 1):fd_ind",
                                      "lag(bank_gdp, 1):euro_member",
                                      "crisis_ind:euro_member")
  
  temp_df = tibble(var_name = names(temp_sign)[temp_ind],
                   value = temp_sign[temp_ind],
                   significance = temp_significance[temp_ind],
                   model = temp_name) %>% 
    mutate(significance = if_else(significance > 2,
                                  "significant", "non_significant"))
  
  return(temp_df)
  
 
}

temp_coef = pmap(list(reg_list,names(reg_list)),
                 extract_coeffs) %>% 
  list_rbind()

# temp_coef %>% 
#   write_csv("C:\\Users\\internet\\Desktop\\full_fin_cycle.csv")

temp_coef %>% 
  mutate(var_name = case_match(var_name,
                    "lag(bank_gdp, 1)" ~ "bank_gdp",
                    "lag(bank_gdp, 1):crisis_ind" ~ "crises effect",
                    "lag(bank_gdp, 1):euro_member" ~ "euro effect",
                    "crisis_ind:euro_member" ~ "crises euro effect",
                    "lag(bank_gdp, 1):fd_ind" ~ "FD effect")) %>%
  filter(significance == "significant") %>% 
  ggplot(aes(x = var_name, y = model, 
             color = as_factor(value))) + 
  geom_point() + 
  xlab(NULL) + ylab(NULL) + 
  theme(legend.position = "none")

```


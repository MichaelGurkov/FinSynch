```{r estimation_libraries}

library(here)

library(stargazer)

```


```{r define_reg_formula_list}

control_vars = c("trade_gdp","fx_stab","fo_ind","gdp_usd")


reg_formula_list = list(
  baseline = paste(
    "fin_synch ~ lag(bank_gdp,1)",
    paste(control_vars,
          collapse = "+"),
    "country_pair:time_trend",
    sep = "+"
  ),
  crises = paste(
    "fin_synch ~ lag(bank_gdp,1) * crisis_ind",
    paste(control_vars,
          collapse = "+"),
    "country_pair:time_trend",
    sep = "+"
  ),
  full_spec = paste(
    "fin_synch ~ lag(bank_gdp,1) * crisis_ind",
    "lag(bank_gdp,1) * fd_ind",
    "lag(bank_gdp,1) * euro_member",
    paste(control_vars,
          collapse = "+"),
    "country_pair:time_trend",
    sep = "+"
  )
)
```


```{r import_data}

rmarkdown::render(here("vignettes","Import_Data.Rmd"),)

```


```{r process_data}

rmarkdown::render(here("vignettes","Process_Data.Rmd"))

```


```{r eda_final_data}

temp = country_pair_df %>% 
  select(-c("country_pair","euro_member")) %>% 
  pivot_longer(-year) %>% 
  group_by(year, name) %>% 
  summarise(num_complete = 1 - sum(is.na(value)) / length(value),
            .groups = "drop")


temp %>% 
  ggplot(aes(year, name)) + 
  geom_point(aes(alpha = num_complete, size = num_complete))

```

```{r eda_cycles_components}

temp = map(c("share_price","house_price"), function(temp_name){
  
  temp_df = raw_data %>% 
  pluck(temp_name)
  
  return(temp_df)

  
  
  
}) %>% 
  reduce(full_join, by = c("country_code", "date"))

temp = temp %>% 
  left_join(raw_data$country_codes[,c("code","country")],
            by = c("country_code" = "code")) %>% 
  select(-country_code)

temp %>% 
  full_join(raw_data %>% 
              pluck("total_credit"), by = c("country","date")) %>% 
  pivot_longer(-c("country","date")) %>% 
  ggplot(aes(date, country, color = !is.na(value))) + 
  geom_point() + 
  facet_wrap(~name)
  

```


```{r estimation}

reg_list = map(reg_formula_list, function(temp_formula){
  
  temp_model = plm(formula = formula(temp_formula),
                   data = country_pair_df,
          model = "within",effect = "twoways",
          index = c("country_pair","year"))
  return(temp_model)
  
})


coef_vec = coefficients(reg_list$full_spec)

coef_vec = coef_vec[names(coef_vec) %in% c("lag(bank_gdp, 1)",
                                           "lag(bank_gdp, 1):crisis_ind",
                                           "lag(bank_gdp, 1):fd_ind")]

sd_ratio = sd(country_pair_df$bank_gdp) / sd(country_pair_df$fin_synch)

isr_ind = str_detect("Israel",country_pair_df$country_pair)

sd_ratio_isr = sd(country_pair_df$bank_gdp[isr_ind]) / sd(country_pair_df$fin_synch[isr_ind])



```


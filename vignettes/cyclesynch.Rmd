---
title: ""
author: "Michael Gurkov"
output: "html_document"     

vignette: >
  %\VignetteIndexEntry{CycleSynch}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,echo = FALSE,
  message = FALSE,warning = FALSE,
  comment = "#>"
)
```


```{r load_package}

devtools::load_all()

library(MiscImport)

library(lubridate)

library(tidyverse)

library(tidymodels)

library(tidyselect)

library(plm)

library(hdm)

library(stargazer)
 
library(scales)

library(glue)

```


```{r child="Import_Data.Rmd"}

```



# OLS estimation

```{r ols}


ols_reg = 

x_vars = names(df)[!names(df) %in% c("synch","fsap_ind")] %>% 
  glue_collapse(sep = "+")

ols_mod = plm(
  formula = formula(glue("synch ~ ", x_vars)),
  model = "within",
  effect = "twoways",
  index = c("countrypair", "date"),
  data = df)

```


# IV estimation

```{r iv}

iv_vars = names(df)[!names(df) %in% c("synch","bank_int")] %>% 
  glue_collapse(sep = "+")

iv_mod = plm(
  formula = glue("synch ~ ", x_vars, "|", iv_vars),
  model = "within",
  effect = "twoways",
  index = c("countrypair", "date"),
  data = df
)

```


# Lasso estimation


```{r my_recipe}

my_recipe = recipe(synch ~ ., data = df) %>% 
  step_rm("fsap_ind") %>% 
  step_mutate(date = factor(date)) %>% 
  step_dummy(c("countrypair", "date"))

```

```{r lasso_estimation}

df_dummy = my_recipe %>% 
  prep() %>% 
  bake(df)


y = df_dummy %>% 
  pull(synch)

d = df_dummy %>% 
  pull(bank_int)

x_mat = df_dummy  %>% 
  select(-c(synch, bank_int)) %>% 
  as.matrix()

```

```{r partial_lasso}

part_Lasso = rlassoEffect(x = x_mat,
                          y = y,
                          d = d,
                          method = "partialling out")

double_Lasso = rlassoEffect(x = x_mat,
                          y = y,
                          d = d,
                          method = "double selection")


```

# Forecasting

```{r predict_synch}

lasso_wf = workflow() %>% 
  add_recipe(my_recipe) %>% 
  add_model(linear_reg(penalty = tune()) %>% 
  set_engine("glmnet"))
  
lasso_fit = lasso_wf %>% 
  tune_grid(resamples = vfold_cv(df),
            grid = grid_regular(penalty(), levels = 10))

final_fit = lasso_wf %>% 
  finalize_workflow(lasso_fit %>% 
  select_best(metric = "rmse"))


```


---
title: "Financial cycles synchronization and financial integration"
author: "Michael Gurkov"
date: "`r Sys.Date()`"
fontsize: 11pt
output:
  rmarkdown::pdf_document:
    latex_engine: xelatex
    number_sections: true
    includes:
            in_header: C:\\Users\\Misha\\Documents\\Financial-Cycle\\GlobalFinancialCycleSynch\\vignettes\\GlobalFinCyclePreambleDoc.tex
bibliography: C:\\Users\\Misha\\Documents\\References\\Financial_Cycle-Global_Financial_Cycle.bib

vignette: >
  %\VignetteIndexEntry{CycleSynch}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,echo = FALSE,cache = TRUE,
  message = FALSE,warning = FALSE,
  comment = "#>"
)
```


```{r load_package}

devtools::load_all()

library(car)

library(tidyverse)

library(plm)

library(stargazer)
 
library(sandwich)

library(clubSandwich)

library(lmtest)

library(purrr)

library(igraph)

```


```{r params_setup}

save_temp_status = FALSE

countries_list = list(
  oecd_countries = c("Australia","Austria","Belgium","Canada","Chile",
                  "Czech_Republic","Denmark","Estonia","Finland","France",
                  "Germany","Greece","Hungary", "Iceland","Ireland",
                  "Israel","Italy","Japan","Korea","Latvia",
                  "Lithuania","Luxembourg","Mexico","Netherlands",
                  "New_Zealand","Norway","Poland","Portugal",
                  "Slovak_Republic","Slovenia","Spain","Sweden",
                  "Switzerland","Turkey","United_Kingdom"
                  ,"United_States"),
  strong_countries = c("Australia","Austria","Belgium","Canada",
                  "Switzerland","Germany","Denmark","Spain",
                  "Finland","France","United_Kingdom","Ireland",
                  "Italy","Japan","Netherlands","Portugal",
                  "Sweden","United_States"),
  fsap_countries = c("Austria","Belgium","Germany","Denmark","Spain",
                   "France","Finland","Greece","Ireland","Italy",
                   "Luxembourg","Netherlands","Portugal",
                   "Sweden","United_Kingdom"))

countries_list$weak_countries = countries_list$oecd_countries[!countries_list$oecd_countries %in% countries_list$strong_countries]


pairs_list = lapply(names(countries_list),
           function(temp_name){
             apply(combn(countries_list[[temp_name]],2), 2,
                   function(temp_col){
                     ifelse(temp_col[1]<temp_col[2],
                            paste(temp_col[1],temp_col[2],sep = "-"),
                            paste(temp_col[2],temp_col[1],sep = "-"))})
  
})

names(pairs_list) = paste(names(countries_list), "pairs", sep = "_")

countries_list = c(countries_list, pairs_list)

rm(pairs_list)

countries_list$cross_country_pairs = countries_list$oecd_countries_pairs[!countries_list$oecd_countries_pairs %in% countries_list$strong_countries_pairs & !countries_list$oecd_countries_pairs %in% countries_list$weak_countries_pairs]

reg_list = list()

hyp_test_list = list()


control_vars = c("trade_gdp","FX_stab_tot","FO_ind_tot","MI_ind_tot","Crises")

```


```{r Import_raw_data}

raw_data = list()

raw_data$HousePrice = import.bis.property.price.data(
  countries_vec = countries_list$oecd_countries) %>% 
  mutate(Date = as.yearqtr(Date, format = "%Y-Q%q"))

raw_data$TotalCredit = import.bis.tot.credit.data(
  countries_vec = countries_list$oecd_countries) %>% 
  mutate(Date = as.yearqtr(Date, format = "%Y-Q%q"))

raw_data$WDI_annual = import_wdi_df(
  countries_vec = countries_list$oecd_countries)


raw_data$bis_lbs = import.bis.lbs.data(
  countries_vec = countries_list$oecd_countries) %>% 
  mutate(Date = as.yearqtr(Date, format = "%Y-Q%q"))

raw_data$Harmon_both_quarter = import.harmon.data() %>% 
  construct_countrypair_harmon_index(.,dates_vec = seq.Date(
    from = as.Date(min(raw_data$bis_lbs$Date)),
    to = as.Date(max(raw_data$bis_lbs$Date)),
    by = "quarter") %>% as.yearqtr())

raw_data$Harmon_one_quarter = import.harmon.data() %>% 
  construct_countrypair_harmon_index(.,dates_vec = seq.Date(
    from = as.Date(min(raw_data$bis_lbs$Date)),
    to = as.Date(max(raw_data$bis_lbs$Date)),
    by = "quarter") %>% as.yearqtr(),index_status = "one")

raw_data$codes = read.csv(paste0("C:\\Users\\Misha\\Documents",
                                 "\\Data\\ISO\\",
                                 "iso_2digit_alpha_country",
                                 "_codes.csv")) %>% 
  setNames(c("Code","Country"))


# Import EU membership indicators



# raw_data$CPI = read_csv(paste0("C:\\Users\\Misha\\",
#                                "Documents\\Data\\FRED",
#                                "\\GDPDEF.csv"),
#                         col_types = cols(
#                           DATE = col_date(format = ""),
#                           GDPDEF = col_double())) %>% 
#   rename(Date = DATE, US_CPI = GDPDEF) %>% 
#   filter(quarters(Date) == "Q4") %>% 
#   mutate(Date = format(Date,"%Y"))
  
  
# raw_data$cpi_quarter = import.bis.cpi.data(annual_freq = FALSE) %>% 
#   mutate(Date = as.yearqtr(Date, format = "%Y.%m")) %>% 
#   group_by(Date) %>% 
#   summarise(US_CPI = mean(US_CPI, na.rm = TRUE))

# raw_data$OECD_quarter = import.oecd.gdp(countries_vec = countries_list$oecd_countries)
  
  

```


```{r Import_raw_data_EU_membership}

eu_df = read.csv(paste0("C:\\Users\\Misha\\Documents\\",
                        "Data\\Misc\\EU_membership.csv"),
                 stringsAsFactors = FALSE) %>% 
  setNames(c("Country","Euro_area","EU"))


eu_dates_vec = seq.Date(
    from = as.Date(min(raw_data$bis_lbs$Date)),
    to = as.Date(max(raw_data$bis_lbs$Date)),
    by = "year") %>% 
  format(.,"%Y")

raw_data$EU_both = construct_countrypair_EU_index(
  df = eu_df %>% 
    select(Country, EU) %>% 
    rename(Date = EU),dates_vec = eu_dates_vec) %>% 
  rename(EU_both = Status) %>% 
  mutate(Date = as.character(Date))

raw_data$EU_one = construct_countrypair_EU_index(
  df = eu_df %>% 
    select(Country, EU) %>% 
    rename(Date = EU),dates_vec = eu_dates_vec,
  index_status = "one") %>% 
  rename(EU_one = Status) %>% 
  mutate(Date = as.character(Date))


raw_data$Euro_both = construct_countrypair_EU_index(
  df = eu_df %>% 
    select(Country, Euro_area) %>% 
    rename(Date = Euro_area),dates_vec = eu_dates_vec) %>% 
  rename(Euro_both = Status) %>% 
  mutate(Date = as.character(Date))

raw_data$Euro_one = construct_countrypair_EU_index(
  df = eu_df %>% 
    select(Country, Euro_area) %>% 
    rename(Date = Euro_area),dates_vec = eu_dates_vec,
  index_status = "one") %>% 
  rename(Euro_one = Status) %>% 
  mutate(Date = as.character(Date))

rm(eu_df, eu_dates_vec)

```


```{r Import_raw_data_crises_dates}

raw_data$crises_df =  import.crises.dates.df(countries_vec = countries_list$oecd_countries)

```


```{r make_annual_df}

df_list = list(raw_data$TotalCredit %>%
  filter(quarters(Date) == "Q4") %>%
  mutate(Date = format(Date, "%Y")) %>% 
  deflate.data(.,vars_to_deflate = "Total_Credit") %>% 
  select(-Total_Credit),
  raw_data$HousePrice %>%
  filter(quarters(Date) == "Q4") %>%
  mutate(Date = format(Date, "%Y")),
  raw_data$WDI_annual %>%
  rename(Date = Year) %>%
  deflate.data(.,vars_to_deflate = c("GDP","GDP_per_Capita"),
               cpi = raw_data$CPI) %>% 
  select(-GDP, -GDP_per_Capita))


df = df_list %>% 
  reduce(right_join, by = c("Date", "Country")) %>% 
  group_by(Country) %>% 
  mutate_at(.vars = c("Total_Credit_real","HousePrice"),
            .funs = list(ret = ~c(NA,diff(log(.))))) %>%
  mutate(Fin_ret = rowMeans(data.frame(Total_Credit_real_ret,
                                      HousePrice_ret),na.rm = TRUE)) %>%
  ungroup() %>%
  filter(is.finite(Fin_ret)) %>% 
  filter(Date >=1978)

rm(df_list)

```


```{r calculate_networks, eval=FALSE}

bank_graph_df = import.bis.lbs.data(
  countries_vec = countries_list$oecd_countries,
  collapse_countrypair = FALSE)  %>% 
  filter(grepl("Q4",Date)) %>% 
  group_by(Country, Counter_Country,Date) %>% 
  summarise(Weight = mean(Balance, na.rm = TRUE)) %>% 
  ungroup() %>% 
  filter(complete.cases(.)) %>% 
  mutate(Date = str_extract(Date,"^\\d{4}"))

net_list = lapply(split(bank_graph_df,bank_graph_df$Date),
                    function(temp_df){
                      links_df = temp_df %>% 
                        select(-Date)
                      
                      net = graph_from_data_frame(links_df)
                      
                      E(net)$weight = links_df$Weight
                      
                      return(net)
                      
                      
                      })

centrality_df = lapply(names(net_list),
                       function(temp_name){
                         
                         in_cent = graph.strength(net_list[[temp_name]],
                                                  mode = "in") %>% 
                           data.frame(Country = names(.),
                                      Date = temp_name,
                                      Center_in = .)
                         
                         out_cent = graph.strength(net_list[[temp_name]],
                                                  mode = "out") %>% 
                           data.frame(Country = names(.),
                                      Date = temp_name,
                                      Center_out = .)
                         
                         df = full_join(in_cent, out_cent,
                                        by = c("Country","Date"))
                         
                         return(df)
                         
                         
                       }) %>% 
  rbind_all()

df = left_join(df, centrality_df, by = c("Country","Date"))

```


```{r make_bank_list}

bank_list = list()

bank_balance_real = raw_data$bis_lbs %>%
  filter(quarters(Date) == "Q4") %>%
  mutate(Date = format(Date, "%Y")) %>%
  mutate(Balance = Balance * 10 ^ 6) %>% 
  deflate.data(.,vars_to_deflate = "Balance") %>%
  select(Date, CountryPair,Balance_Pos, Balance_real)


bank_list$bank_gdp = bank_balance_real  %>%
  normalize.bis.data(.,norm_df = df[,c("Date","Country", "GDP_real")],
                     norm_val = "GDP_real") %>% 
  group_by(Date, CountryPair) %>%
  summarise(bank_gdp = mean(log(Balance_real), na.rm = TRUE)) %>%
  filter(!is.na(bank_gdp))
  
# bank_pop = bank_balance_real  %>%
#   normalize.bis.data(.,norm_df = df[,c("Date","Country", "Pop")],
#                      norm_val = "Pop") %>% 
#   group_by(Date, CountryPair) %>%
#   summarise(bank_pop = mean(log(Balance_real), na.rm = TRUE)) %>%
#   filter(!is.na(bank_pop))

rm(bank_balance_real)


```


```{r make_indicators_list}

ind_list = list()
  
  ind_list$Harmon_both =  raw_data$Harmon_both_quarter %>% 
                         mutate(Date = format(Date, "%Y")) %>% 
                         group_by(CountryPair, Date, Directive) %>% 
                         summarise(Transposed = max(Transposed)) %>% 
                         group_by(Date,CountryPair) %>% 
                         summarise(Harmon_both_Index = log(
                           sum(Transposed + 1,na.rm = TRUE)))
  
   ind_list$Harmon_one = raw_data$Harmon_one_quarter %>% 
                         mutate(Date = format(Date, "%Y")) %>% 
                         group_by(CountryPair, Date, Directive) %>% 
                         summarise(Transposed = max(Transposed)) %>% 
                         group_by(Date,CountryPair) %>% 
                         summarise(Harmon_one_Index = log(
                           sum(Transposed + 1,na.rm = TRUE)))
   
   ind_list$EU_both = raw_data$EU_both
   
   ind_list$EU_one =  raw_data$EU_one
   
   ind_list$Euro_both =  raw_data$Euro_both
                       
   ind_list$Euro_one = raw_data$Euro_one


```


```{r Import_IMF_Data}

trade_list = list()

export_df = lapply(list.files(paste0("C:\\Users\\Misha\\Documents\\Data",
                                     "\\IMF\\Export-Import\\Export"),
                              full.names = TRUE),
                   import_imf_df,
                   countries_vec = countries_list$oecd_countries) %>% 
  bind_rows() %>% 
  mutate(Exports = as.numeric(Exports)) %>% 
  group_by(Date, CountryPair) %>% 
  summarise(Exports = sum(Exports, na.rm = TRUE))


import_df = lapply(list.files(paste0("C:\\Users\\Misha\\Documents\\Data",
                                     "\\IMF\\Export-Import\\Import"),
                              full.names = TRUE),
                   import_imf_df,
                   countries_vec = countries_list$oecd_countries) %>% 
  bind_rows() %>% 
  mutate(Imports = as.numeric(Imports)) %>%
  group_by(Date, CountryPair) %>% 
  summarise(Imports = sum(Imports, na.rm = TRUE))

trade_df = full_join(export_df,import_df) %>% 
  gather(.,key = Balance_Pos, value = Trade, -Date, - CountryPair) %>% 
  deflate.data(.,vars_to_deflate = "Trade") %>% 
  select(-Trade)


trade_list$trade_gdp = trade_df %>%
  ungroup() %>% 
  normalize.imf.data(.,wdi_df = df[,c("Date","Country", "GDP_real")],
                     norm_val = "GDP_real") %>%
  group_by(Date, CountryPair) %>%
  summarise(trade_gdp = mean(log(Trade_real), na.rm = TRUE)) %>%
  filter(!is.na(trade_gdp)) %>% 
  filter(is.finite(trade_gdp))

rm(export_df, import_df, trade_df)



```


```{r make_countrypair_df}


country_pair_df = unlist(list(bank_list, trade_list, ind_list),
                         recursive = FALSE) %>% 
  reduce(left_join, by = c("Date","CountryPair"))


country_pair_df = country_pair_df %>% 
  mutate_at(.vars = vars(c("EU_both","EU_one","Euro_both","Euro_one")),
            .funs = ~(ifelse(is.na(.),0,.)))


```


```{r Import_trilemma_data}

df = left_join(df, import.trilemma.ind(),
               by = c("Country","Date"))

```


```{r Import_macroprudata, eval=FALSE}

df = full_join(df, import.macropru.ind(),
               by = c("Country","Date"))



```


```{r Import_fin_development_data}

df = left_join(df, import.fin.dev.ind(),
               by = c("Country","Date"))



```


```{r Import_WGI_data}

df = left_join(df, import.wgi.ind(countries_vec = countries_list$oecd_countries) %>% 
  filter(grepl("Estimate$", Indicator)) %>% 
  group_by(Country, Date) %>% 
  summarise(WGI = mean(Val, na.rm = TRUE)),
  by = c("Country","Date"))

```

<!-- Dataset construction -->

```{r make_fin_reg_df}

fin_reg_df_annual = construct_fin_reg(
  df = df %>% 
    mutate(GDP_real = log(GDP_real),
           Pop = log(Pop)),
  countries_vec = countries_list$oecd_countries,
  control_vars = names(df)[!names(df) %in% c("Country","Date","Fin_ret")],
  collapse_funcs = c("sum"))

fin_reg_df_annual = fin_reg_df_annual %>% 
  full_join(.,country_pair_df, by = c("Date","CountryPair"))

fin_reg_df_annual = fin_reg_df_annual %>% 
  filter(!is.na(CountryPair)) %>% 
  filter(!is.na(Fin_synch)) %>% 
  filter(!is.na(bank_gdp)) %>% 
  filter(!is.na(Date))


temp_lm_resid = function(x,Time){
  
  if(sum(!is.na(x)) < 2){return(rep(NA, length(x)))}
  
  return(residuals(lm(x ~ Time)))
  
}


fin_reg_df_annual = fin_reg_df_annual %>% 
  group_by(CountryPair) %>% 
  mutate(Time_trend = seq.int(from = 1,to = length(Date))) %>% 
  mutate(bank_gdp_delta = c(NA, diff(bank_gdp))) %>% 
  mutate(Fin_synch_delta = c(NA, diff(Fin_synch))) %>% 
  mutate(bank_gdp_detrended = temp_lm_resid(bank_gdp, Time_trend)) %>% 
  mutate(Fin_synch_detrended = temp_lm_resid(Fin_synch, Time_trend)) %>% 
  mutate(Harmon_both_detrended = temp_lm_resid(Harmon_both_Index,
                                               Time_trend)) %>% 
  ungroup()

fin_reg_df_annual$CountryPair_Category[fin_reg_df_annual$CountryPair %in% countries_list$strong_countries_pairs] = "Strong"

fin_reg_df_annual$CountryPair_Category[fin_reg_df_annual$CountryPair %in% countries_list$cross_country_pairs] = "Cross"

fin_reg_df_annual$CountryPair_Category[fin_reg_df_annual$CountryPair %in% countries_list$weak_countries_pairs] = "Weak"



# saveRDS(fin_reg_df_annual, "C:\\Users\\Misha\\Desktop\\temp_df.rds")


```


```{r fin_reg_df_add_crises_indicator}

fin_reg_df_annual = fin_reg_df_annual %>% 
  separate(col = CountryPair,into = c("Country_A","Country_B"),
           sep = "-", remove = FALSE) %>% 
  group_by(Country_A) %>% 
  mutate(Country_A_crises = classify_crises_dates(
    Target_Country = Country_A[1],
    dates_vec = Date,
    crises_df = raw_data$crises_df[,1:3])) %>% 
  group_by(Country_B) %>% 
  mutate(Country_B_crises = classify_crises_dates(
    Target_Country = Country_B[1],
    dates_vec = Date,
    crises_df = raw_data$crises_df[,1:3])) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(Crises_tot = sum(Country_A_crises, Country_B_crises)) %>% 
  mutate(Crises_one = as.numeric(Crises_tot ==1)) %>% 
  mutate(Crises_both = as.numeric(Crises_tot ==2)) %>% 
  mutate(Crises = min(Crises_tot,1)) %>% 
  ungroup() %>% 
  select(-Country_A,-Country_B)

```


```{r save_temp_data, eval=save_temp_status}

write_rds(x = raw_data,
        path = "C:\\Users\\Misha\\Documents\\Data\\TempData\\temp_raw_df.rds")


write_rds(x = fin_reg_df_annual,
        path = "C:\\Users\\Misha\\Documents\\Data\\TempData\\temp_fin_df.rds")

```



<!-- Network construction -->

```{r plot_network, eval=FALSE}


links_df = import.bis.lbs.data(countries_vec = countries_list$oecd_countries,
                               collapse_countrypair = FALSE)  %>% 
  group_by(Country, Counter_Country) %>% 
  summarise(Weight = mean(Balance, na.rm = TRUE)) %>% 
  ungroup()


nodes_df = rbind(data.frame(Country = links_df$Country,
                            Type = "Source"),
                 data.frame(Country = links_df$Counter_Country,
                            Type = "Target")) %>% 
  distinct()
  
net = graph_from_data_frame(d = links_df)

E(net)$weight = links_df$Weight

# net = delete_edges(net, E(net)[weight<mean(weight)])

plot(net, vertex.size = log(graph.strength(net) / 10),
     edge.arrow.size = 0, xlim = c(-0.8,0.8), ylim = c(-0.5,0.8),
     asp = 0,
     layout = layout.gem(net))

plot(net, vertex.size = log(graph.strength(net) / 10),
     edge.arrow.size = 0,layout = layout.gem(net))

plot(net, vertex.size = log(graph.strength(net)) * 1.5,
     edge.arrow.size = 0,layout = layout.lgl(net))


```


<!-- Regression analysis -->


```{r estimation_panel_reg}

cont_df = fin_reg_df_annual %>% 
    select(c("Date", "CountryPair","Fin_synch","bank_gdp",
             "Time_trend",
             control_vars,"EU_both")) %>% 
    filter(complete.cases(.))

cont_formula = paste("Fin_synch ~ lag(bank_gdp,1) * Crises",
                     "EU_both",
                     paste(control_vars, collapse = "+"),
                     "CountryPair:Time_trend",
                     sep = "+")


reg_list$panel = make_strata_reg_list(
  countries_list = countries_list,
  reg_df = cont_df,
  reg_formula = formula(cont_formula))


hyp_test_list$panel =
  lapply(reg_list$panel,
         function(temp_lm){linearHypothesis(temp_lm,
                 "lag(bank_gdp, 1) = lag(bank_gdp, 1):Crises",
                 vcov. = vcovHC(temp_lm,cluster = "group"))})




rm(cont_df)


```


```{r estimation_panel_reg_fd}

cont_df_fd = fin_reg_df_annual %>% 
    select(c("Date", "CountryPair","Fin_synch","bank_gdp",
             control_vars,"Time_trend",
             "FD_tot","EU_both")) %>% 
    filter(complete.cases(.))

cont_fd_formula = paste("Fin_synch ~ lag(bank_gdp,1) * Crises",
                         "EU_both",
                         "lag(bank_gdp,1) *FD_tot",
                         paste(control_vars, collapse = "+"),
                        "CountryPair:Time_trend",
                     sep = "+")


reg_list$panel_fd = make_strata_reg_list(
  countries_list = countries_list,
  reg_df = cont_df_fd,
  reg_formula = formula(cont_fd_formula))



rm(cont_df_fd,cont_fd_formula)


```


```{r estimation_panel_reg_fd_wgi_controls}

cont_df_fd_wgi = fin_reg_df_annual %>% 
    select(c("Date", "CountryPair","Fin_synch","bank_gdp","WGI_tot",
             control_vars,"FD_tot","EU_both","Time_trend")) %>% 
    filter(complete.cases(.))

cont_fd_wgi_formula = paste("Fin_synch ~ lag(bank_gdp,1) * Crises",
                         "EU_both",
                         "lag(bank_gdp,1) * FD_tot",
                         "lag(bank_gdp,1) * WGI_tot",
                         paste(control_vars, collapse = "+"),
                         "CountryPair:Time_trend",
                     sep = "+")

reg_list$panel_fd_wgi = make_strata_reg_list(
  countries_list = countries_list,
  reg_df = cont_df_fd_wgi,
  reg_formula = formula(cont_fd_wgi_formula))

# hyp_test_list$twoways_lin_trend__FD =
#   lapply(reg_list$twoways_lin_trend__FD,
#          function(temp_lm){linearHypothesis(temp_lm,
#                  "bank_gdp = bank_gdp:Crises",
#                  vcov. = vcovHC(temp_lm,cluster = "group"))})
# 


rm(cont_df_fd_wgi)


```


```{r estimation_panel_reg_2007}

cont_df_2007 = fin_reg_df_annual %>% 
    select(c("Date", "CountryPair","Fin_synch","bank_gdp",
             "Time_trend", control_vars,"EU_both")) %>% 
  filter(complete.cases(.)) %>% 
  filter(Date <= 2006)

cont_formula_2007 = paste("Fin_synch ~ lag(bank_gdp,1) * Crises",
                     "EU_both",
                     paste(control_vars, collapse = "+"),
                     "CountryPair:Time_trend",
                     sep = "+")


reg_list$panel_2007 = make_strata_reg_list(
  countries_list = countries_list,
  reg_df = cont_df_2007,
  reg_formula = formula(cont_formula_2007))


# hyp_test_list$panel =
#   lapply(reg_list$panel,
#          function(temp_lm){linearHypothesis(temp_lm,
#                  "bank_gdp = bank_gdp:Crises",
#                  vcov. = vcovHC(temp_lm,cluster = "group"))})




rm(cont_df_2007)


```


```{r estimation_panel_reg_fd_2007}

cont_df_fd_2007 = fin_reg_df_annual %>% 
    select(c("Date", "CountryPair","Fin_synch","bank_gdp",
             control_vars,"Time_trend","FD_tot","EU_both")) %>% 
  filter(complete.cases(.)) %>% 
  filter(Date <= 2006)

cont_fd_formula_2007 = paste("Fin_synch ~ lag(bank_gdp,1) * Crises",
                         "EU_both",
                         "lag(bank_gdp,1) *FD_tot",
                         paste(control_vars, collapse = "+"),
                        "CountryPair:Time_trend",
                     sep = "+")


reg_list$panel_fd_2007 = make_strata_reg_list(
  countries_list = countries_list,
  reg_df = cont_df_fd_2007,
  reg_formula = formula(cont_fd_formula_2007))



rm(cont_df_fd_2007,cont_fd_formula_2007)


```


```{r estimation_panel_reg_fd_wgi_controls_2007}

cont_df_fd_wgi_2007 = fin_reg_df_annual %>% 
    select(c("Date", "CountryPair","Fin_synch","bank_gdp","WGI_tot",
             control_vars,"FD_tot","EU_both","Time_trend")) %>% 
  filter(complete.cases(.)) %>% 
  filter(Date <= 2006)


cont_fd_wgi_formula_2007 = paste("Fin_synch ~ lag(bank_gdp,1) * Crises",
                         "EU_both",
                         "lag(bank_gdp,1) * FD_tot",
                         "lag(bank_gdp,1) * WGI_tot",
                         paste(control_vars, collapse = "+"),
                         "CountryPair:Time_trend",
                     sep = "+")

reg_list$panel_fd_wgi_2007 = make_strata_reg_list(
  countries_list = countries_list,
  reg_df = cont_df_fd_wgi_2007,
  reg_formula = formula(cont_fd_wgi_formula_2007))

# hyp_test_list$twoways_lin_trend__FD =
#   lapply(reg_list$twoways_lin_trend__FD,
#          function(temp_lm){linearHypothesis(temp_lm,
#                  "bank_gdp = bank_gdp:Crises",
#                  vcov. = vcovHC(temp_lm,cluster = "group"))})
# 


rm(cont_df_fd_wgi_2007)


```


```{r save_temp_reg, eval=save_temp_status}

write_rds(x = reg_list,
        path = "C:\\Users\\Misha\\Documents\\Data\\TempData\\temp_reg.rds")

```



<!-- Instrumental variable regression -->



\section{Introduction} 

Financial integration is a phenomenon in which financial markets in neighboring, regional and/or global economies are closely linked together. This fenomenon received close attention in the academic literature (see [@Kose2009] for summary and survey of the literature). Potential benefits of financial integration include efficient capital allocation, better governance, higher investment and growth, and risk-sharing. At the same time financial integration can also have adverse effects. A higher degree of financial integration can generate a severe financial contagion in integrated economies. [@Popov2012] study banking integration and identify a mechanism by which financial shocks progate through cross border linkages. The authors show that a negative shock to parent (foreign) bank leads to reduction in lending provided by it's subsiduaries abroad.
[@Degryse2010] analyze the extent of contagion risk through. They focus on 1999-2006 period and ran a simulation based on cross border bank linkages and banks equity. The authors conclude that contagion risk and the "speed of propagation of contagion" have increased during that period. They also find that contagion is more widespread in geographical proximities.
 

Another important concept that has gained attention as a result of the global financial crisis is the financial cycle. Financial cycle can be defined as "deviations from long term trend of variables that are important to financial stability".

This work attempts to study the relationship between financial cycles synchronization and financial integration. The main motivation for this work is an important paper by [@Kalemli-Ozcan2013JF] that study the relationship between business cycles synchronization and financial integration (through bank linkages). The reseachers find that output cycle synchronization is negatively affected by financial integration (represented by Bank linkages). The suggested mechanism by which financial integration results in business cycle divergence is cross border banking flows : if a country is hit with a negative productivity shock global banks will reduce credit to that country and increase credit to another country thus exacerbating negative output effect in the former country and facilitating positive output effect in the latter. 

My hypothesis is that this suggested mechanism should have similiar effect on the synchronization of financial cycles. In the interests of comparability and interpretation of the results I try to follow the methodology employed by [@Kalemli-Ozcan2013JF] as close as possibile so that the novice contributuon of this paper is the use of the suggested methodology in a new (complementary) field. 
Another important contribution is sample extension. The authors sample includes 18 "Hi Income" members of OECD (These countries are: Australia, Austria, Belgium, Canada, Switzerland, Germany, Denmark, Spain, Finland, France, the United Kingdom, Ireland, Italy, Japan, Netherlands, Portugal, Sweden, and the United States) for the period of 1978-2006. To take advantage of the whole available data I expand my sample to all OECD countries for the period of `r paste(range(fin_reg_df_annual$Date), collapse = "-")`. In the second part of the paper I analyze the period 1978-2006 to compare my results to their work. This analysis have an additional benefit of excluding the Global Financial Crises period. I also explore robustness issues with respect to the selection of sample and variables and suggest some further research directions.


The paper is structured as follows. In section \ref{LitReview} I review the relevant literature and theoretical considerations. Section \ref{Data} provides a description of the data and empirical hypothesis are formulated in section \ref {Hypothesis}. Section \ref{results} presents the estimation results and section \ref{conclusions} consludes the paper.

\section{Literature review} \label{LitReview}

[@Avdjiev2019] study the factors that affect lending behavior of global banks’ subsidiaries throughout the world. The authors divide the influencing factors to two groups: "push" (global drivers) factors and "pull" factors such as macroeconomic conditions that measure the local cost of funding and the strength of the borrowers' balance sheets and the financial conditions of the global bank's subsidiaries.The authors find that the lending behavior of the subsidiaries is more closely related to local macroeconomic conditions and their financial conditions than to those of their owner-specific counterparts, namely that the "pull" factors are more important relative to "push" factors. From financial stability point of view the "push" factors increase synchronization (a.k.a contagion or propagation) while the "pull" factors should reduce synchronization (a.k.a absorption) due to idiosynchratic shocks.


[@Cerutti2015] analyze the composition and drivers of cross-border bank lending between 1995 and 2012, distinguishing between syndicated and non-syndicated loans. They find that greater information assymetries (less economic integration, greater distance, cultural differences) are associated with less cross border lending. Country characteristics such as level of development, economic size, capital account openess and institutional quality are also important but less so for syndicated loans meaning syndication has a diversification determinant. Another important finding is that banking integration (cross border credit) is closely related to the level of development and sophistication of the banking system, strength of balance sheets and regulation.
 

[@Kalemli-Ozcan2013] show that the negative association between financial integration and business cycle synchronization is significantly weaker during periods characterized by adverse financial conditions, suggesting that financial crises induce co-movement among more financialy integrated countries. 


\section{Data} \label{Data}

\subsection{Bank linkages}

I use data on bilateral cross-border bank positions gathered from the Bank for International Settlements’ (BIS) databank on the residence-based locational banking statistics (LBS). The LBS detail at the country level the geographical composition of banks’ balance sheets and capture outstanding claims and liabilities of banking offices located in the BIS reporting countries, including intragroup positions, and exclude local claims of foreign branches and subsidiaries. 

The BIS statistics have possibly the most extensive time coverage from all similar database on cross-border investment holdings (as a comparison to the IMF CPIS database that reports bilateral cross-border financial flows and stocks after 1999). The main limitation of the dataset is that it reports the aggregate international exposure only of the banking system. Yet, cross-border banking activities have been the largest component of cross-border investment in the 1980s and the 1990s, and even nowadays it consists of the bulk of international finance. As long as there is a high correlation between international banking and other forms of portfolio investment (equity flows, FDI, and debt flows), my estimates will not be systematically biased. The BIS data are expressed originally in current U.S. dollars. Following [@Kalemli-Ozcan2013JF] I convert the data into constant U.S. dollars by deflating the series with the U.S. consumer price index (CPI). Then I use the total stock of external assets and liabilities to construct a quantity-based measures of financial integration\footnote {Stocks seem to be beter measurements than flows for financial integration,see [@Prasad2003]}. My main measure is the average of (the logs of) real bilateral asset and liability holdings as a share of the two countries’ GDP. 

\begin{equation*}
	\begin{aligned}
  	Banklinkages_{i,j,t} =& \frac{1}{4} \bigg[
  	log\left(\frac{Assets_{i,t}}{GDP_{i,t} + 
  	GDP_{j,t}}\right)  + log\left(\frac{Liabilities_{i,t}}{GDP_{i,t} + 
  	GDP_{j,t}}\right)  + \\ & log\left(\frac{Assets_{j,t}}{GDP_{i,t} +
  	GDP_{j,t}}\right)  + log\left(\frac{Liabilities_{j,t}}{GDP_{i,t} +
  	GDP_{j}}\right) \bigg]
	\end{aligned}
\end{equation*}



\subsection{Financial cycles synchronization}
To estimate the financial cycle I use total credit and property prices data. Importantly, total credit account for credit from all sources, namely credit from financial accounts, domestic bank credit and cross-border bank credit are the three main building blocks underlying the construction of the total credit series. Property prices come from BIS selected residential property prices data set. The selected residential property prices are harmonised as much as possible with recommendations in the Handbook on residential property prices, an internationally agreed framework for classifying property price issues.

Credit and property prices considered as the most fundamental components of the financial cycle and are extensively used in the literature (see [@Drehmann2012], [@Grinderslev2017]). [@Borio2014] argues that the most parsimonius description of the financial cycle can be made in terms of credit and property prices. I calculate the annual log difference of each variable and then take simple average to obtain the growth of the financial cycle. As a measure of synchronization of financial cycles I use the negative of divergence in growth rates defined as the abosulte value of financil cycle growth differences between country i and country j in period t.

\begin{equation*}
FinSynch_{i,j,i} = -\lvert (Y_{i,t} - Y_{i,t-1}) - (Y_{j,t} - Y_{j,t-1}) \rvert
\end{equation*}

where:

\begin{equation*}
Y_{i,t} = 0.5 \cdot ln \left(  \frac{TotalCredit_{t}}{TotalCredit_{t-1}} \right) 
+0.5 \cdot ln\left( \frac{HousePrice_{t}}{HousePrice_{t-1}} \right) 
\end{equation*}	

This index is simple and quite popular (for example [@Kalemli-Ozcan2013], [@Giannone2010]). In contrast to the correlation measures it is not sensitive to the various filtering methods that have been criticized on many grounds (e.g.,[@Canova1998]).
It also does not contain estimation error that emerges, for example, from self-selecting a rolling estimating window. Nethertheless in the second part of the paper I examine additional synchronization measures to test the robustness of the result.


\section{Descriptive Statistics} \label{DescStat}


```{r plot_bank_gdp,fig.cap="\\label{plot_bank_gdp}",fig.height=5}

ggplot() + 
  labs(title = "Average bank linkages \n (real, normalized by gdp)",
       y = "", x = "") + 
  geom_line(fin_reg_df_annual  %>% 
              filter(CountryPair_Category == "Strong") %>% 
              select(Date, bank_gdp) %>% 
              group_by(Date) %>% 
              summarise(Avg_bank = mean(bank_gdp, na.rm = TRUE)) %>% 
              ungroup() %>% 
              filter(complete.cases(.)),
            mapping = aes(x = Date, y = Avg_bank, group = 1)) + 
  geom_rect(data = raw_data$crises_df %>% 
              select(Start,End),
            mapping = aes(xmin = Start,xmax = End,
                          ymin = -Inf, ymax = Inf),
            fill = "lightgray", alpha = 0.1) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0,size = 7),
        axis.text.y = element_blank(),axis.ticks.y = element_blank(),
        legend.position = "bottom", plot.title = element_text(hjust = 0.5),
        axis.title.x = element_blank())


```

Figure \ref{plot_bank_gdp} shows the average cross border (bilateral) bank linkages of the countries in my sample. We can see that financial integration had increased since 1980s until 2007-2008 (the Global Financial Crises)  and the trend had been reversed since. The shaded area in the figure refer to dates of banking crises in the sample countries and it seems that those are associated with a decrease in financial integration.


```{r plot_bank_gdp_strata,fig.cap="\\label{plot_bank_gdp_strata}",fig.height=3}

ggplot(fin_reg_df_annual %>% 
         select(Date, CountryPair,CountryPair_Category,bank_gdp) %>% 
         mutate(CountryPair_Category = recode(
           CountryPair_Category,
           Strong = "Hi Income group",
           Weak = "Low Income group",
           Cross = "Cross (Hi - Low) Income group")) %>% 
         group_by(Date, CountryPair_Category) %>% 
         summarise(avg_bank_gdp = mean(bank_gdp)),
       aes(x = Date, y = avg_bank_gdp, group = 1)) + 
  geom_line() + 
  labs(y = "", x = "") + 
  theme_bw() + 
  labs(title = "Bank linkages by country groups") + 
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        panel.grid = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  facet_grid(~CountryPair_Category)

```


```{r plot_average_cycle_synch,fig.cap="\\label{plot_Fin_synch}",fig.pos="H"}

ggplot(fin_reg_df_annual %>% 
         filter(CountryPair_Category == "Strong") %>% 
         select(Date, Fin_synch) %>% 
         group_by(Date) %>% 
         summarise(Avg_Fin_synch = mean(Fin_synch, na.rm = TRUE)) %>% 
         ungroup() %>% 
         filter(complete.cases(.)) %>% 
         filter(is.finite(Avg_Fin_synch)),
       aes(x = Date, y = Avg_Fin_synch, group = 1)) + 
  labs(title = "Average financial cycle synchronization",y = "", x = "") + 
  geom_line() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0),
        legend.position = "bottom", plot.title = element_text(hjust = 0.5))


```


Figure \ref{plot_bank_gdp_strata} shows the time trajectory of bank linkages (normalized by GDP) broken into Hi Income and Low Income country pairs groups.
Hi Income group includes `r paste(gsub("_"," ",paste(countries_list$strong_countries[1:length(countries_list$strong_countries) - 1],collapse = ",")), "and",countries_list$strong_countries[length(countries_list$strong_countries)])`
and Low Income group includes `r paste(gsub("_"," ",paste(countries_list$weak_countries[1:length(countries_list$weak_countries) - 1],collapse = ",")), "and",countries_list$weak_countries[length(countries_list$weak_countries)])`.
The plot shows that each group is characterized by it own trend : while Hi Income countries exhibit upward trend, Low Income countries show dramatic drop (probably as a result of GFC). The Cross groups sample (being the "average" of the two previous groups) doesn't show as significant trend as the other groups. In the regression analysis I use country-pair specific trend to account for this non stationary behaviour. 

Figure \ref{plot_Fin_synch} shows the average synchronization (measured as the difference between credit and house price growth rates for each country-pair). The synchronization seems to be quite volatile with no specific trend until 2007-2008 (the global financial crises) and the synchronization had increases since. 


```{r countrypair_table_summary, results="asis"}

temp_df = fin_reg_df_annual %>% 
  select(Fin_synch, bank_gdp, CountryPair_Category) %>% 
  mutate(CountryPair_Category = recode(
    CountryPair_Category,
    Strong = "Hi Income country pairs",
    Weak = "Low Income country pairs",
    Cross = "Cross (Hi - Low) Income country pairs")) %>% 
  as.data.frame()

df_list = split(temp_df, temp_df$CountryPair_Category)
  

stargazer(df_list,table.placement = "H",
          header =FALSE, summary = rep(TRUE,3),
          title = names(df_list),
          summary.stat = c("max","min","mean","median","sd","n"))


rm(temp_df, df_list)

```



\section{Hypothesys formulation} \label{Hypothesis}


The basic specification  (following along the lines of [@Kalemli-Ozcan2013JF]) is

$FinSynch_{i,j,i} = \alpha_{i,j} + \delta_{t} + \beta BankLinkages_{i,j,t-1} + Controls_{i,j,t} + \varepsilon_{i,j,t}$

This specificaiton includes time and country-pair fixed effect in order to control for unobservable time and country-pair specific factors (such as cultural difference or turmoil years). The year fixed effects account for the effect of global shocks and other common time-varying factors that affect both financial cycle patterns and banking integration. The country-pair effects account for hard-to-measure factors such as cultural ties and similarities, informational frictions, and other time-invariant unobservable factors that have an effect on both financial integration and financial cycle patterns.To account for the upward trend and the nonstationary nature of banking integration (see Figure \ref{plot_bank_gdp}), I add country-pair specific linear time trend. I choose linear trend for reasons of simplicity and comparatability with [@Kalemli-Ozcan2013JF], see [@Bouvatier2015] for use of trends in banking integration measures. It should be noted that my results are quite sensitive to the inclusion of the trend and it may be the case that the trend picks up the effect of some other omitted variable. Since I'm only interested in estimating the bank linkages effect in the regression (as opposed to explicitly modeling all the factors that affect financial synchronization), controlling for other variables (trend or another omitted variable) seems required.


The estimation results can be subject to endogeneity problem for reasons of omitting relevant variable or reverse causality. In order to address this issue I take several steps : first, I augment the specified regression with a set of variables in order to control for another economic factors that can effect both financial cycle synchronization and banking integration. [@Chinn2010] suggest that the most important factors for monetary policy are foreign exchange stability, monetary independence and financial openness. The authors construct indexes of the relevant measures and I include them in the controling variables set. I also include trading linkages, financial development and governance measures. All the variables are explained in the Appendix. 
Second, bank linkages enter in my specification in a lagged form (again following [@Kalemli-Ozcan2013JF]), that should attenuate the reverse causality problem.

The theory provides ambigous predictions regarding the effect of financial integration. On the one hand financial integration can help diversify risk, redirect capital to more 
profitable investment opportunities and act as country specific "shock absorber". In that case I should see negative association between financial cycles synchronization and banking integration. On the other hand financial integration can induce contagion effects and act as global "shock propagator". In that case the observed association between financial cycles synchronization and banking integration should be positive. I make an attempt to disentangle these opposite components by identifiyng settings in which the effect of specific component increases.

\subsection{Crisis effect}
Several papers (see [@Kalemli-Ozcan2013], [@Aysun2019], [@Fratzscher2012]) find that during financial crises times the effect of global ("push") factors in cross border bank lending increases and lending becomes more synchronized.

In order to account for those findings I introduce an indicator variable for banking crises periods. The data comes from an updates version of [@Laeven2013] and includes the start and end year of banking crises in the OECD countries for the entire sample period. I expect that the effect of banking integration will be different in crises vs normal times and in order to capture this difference I add an interaction variable between bank linkages and crisis indicator to the estimation equation.

\subsection{Financial development}

[@Mendoza2009] study the relationship between financial development and global imbalances. The authors show that financial development varies widely even among industrial countries and that financial integration can have different effects (even resulting in global financial imbalances) when countries differ in financial markets development. Countries with deeper financial markets react to financial integration by borrowing from abroad and investing in high-return foreign risky assets while countries that are less financial developed accumulate positions in safer assets.

[@Masten2008] analyze the effects of financial development on economic growth. Deeper financial markets reduce transaction and information costs and help diversify risk.
They find that the effect is non linear. They also adress the issue of interaction between financial development and financial integration arguing that financial integration has a positive effect on growth only after the development of national financial market reaches certain threshold. 

[@Fisman2004] analyze the role of financial development in allocating resources. They argue that global (productivity) shocks will induce comovement of growth rates amoung countriues with high level of financial development since undeveloped countries will not be able to react to the shocks of other countries. Thus financial development at high level can transmit global shocks and induce comovement in economic activity.

I hypothesise that this phenomenon (financial development at high level inducing comovement) can hold with respect to financial activity as well. An example is given in [@Acharya2010]. The authors analyze an investment strategy of large commercial banks that set up asset back commercial paper (ABCP) conduits. This strategy involved selling to investors short-term asset-backed commercial paper and investing the proceeds mainly in US asset back longer term securities. Once negative news about US assets emerged, all the banks suffered significant losses thus inducing comovement. This investment strategy required a highly developed domestic financial market (financing through commercial paper), and it is not surprising that the list of countries who's bank were pursuing this strategy includes US,UK,Germany, France, Belgium and Portugal - all members of Hi Income countries classification in my paper.



To account for the fact that the effect of financial integration depends on the level of domestic financial development I include an index of financial development and an interaction term between financial development and banking integration.





\subsection{Institutional strength and Governance}

[@Alfaro2007] study the dynamics of international capital flows in the period 1970-2000. The authors address the stylized fact that states that capital flows mainly between rich countries and not from rich to poor ones ("diversification finance" instead of "development finance"). They suggest that one of the main determinants of capital flows is institutional quality and difference in the institutional quality among the rich and poor countries exlpain this finding.

[@Fratzscher2012] finds that countries with higher institutional quality are less likely to experience sharp capital reversals and that better institutions may be instrumental in insulating a country from negative external shocks.


[@Cerutti2015] analyze the composition of cross border lending. They differentiate between syndicated and bilateral loans. The authors show that composition of lending to EME countries is determined by institutional quality. Higher institutional quality attracts syndicated loand that tend to be more stable relative to bilateral loans.

After adressing al the previously described effect my full specification is 

\begin{equation*}
		\begin{aligned}
		FinSynch_{i,j,i} &= \beta BankLinkages_{i,j,t-1} + 
		\gamma_{1} Crises_{i,j,t} +
		\gamma_{2} BankLinkages_{i,j,t-1} * Crises_{i,j,t} \\
		&  + \delta_{1} FinancialDevelopment_{i,j,t} 	+
		\delta_{2} BankLinkages_{i,j,t-1} * FinancialDevelopment_{i,j,t} \\
		& + \theta_{1} InstitutionalGovernance_{i,j,t} +
		\theta_{2} BankLinkages_{i,j,t-1} * InstitutionalGovernance_{i,j,t}  \\
		& + Controls_{i,j,t}  + \omega_{i,j} +
		\tau_{t} + \varepsilon_{i,j,t}	
		\end{aligned}
\end{equation*}

My hypotheses are:

\textbf{H1 - Banking integration effect} 
\newline
Theory gives ambiguos prediction about the relationship between financial cycles synchronization and banking integration. Financial integration can be a "shock absorber" and in that case the sign should be negative. On the other hand integration can be a "shock propagator" and then the sigh should be positive. The bottom line is that I don't have a clear prediction regarding the sign of banking integration coefficient.

\textbf{H2 - Crisis effect} 
\newline
During financial crises times common (global) shocks are prevalent and that should induce more synchronized financial cycles. That means that the crisis effect should be positive and the "shock propagator" role of banking integration should increase during crisis times. Thus the hypothesis is that $\gamma_{1} > 0, \gamma_{2} > 0$.

\textbf{H3 - Financial development effect} 
\newline
Financial development at high level can transmit global shocks and induce comovement in economic and financial activity. In that case my hypothesis is that $\delta_{1} > 0, \delta_{2} > 0$.

\textbf{H4 - Institutional Governance effect} 
\newline
Institutional governance enable diversification and risk sharing, this should reduce the synchronization of finanacial cycles so the hypothesis is that $\theta_{1} < 0, \theta_{2} < 0$.


\section{Estimation and results} \label{results}

Unfortunately data on financial development is available only for `r paste(range(fin_reg_df_annual$Date[!is.na(fin_reg_df_annual$FD_tot)]), collapse = "-")` period and data on insititutional governance available only for `r paste(range(fin_reg_df_annual$Date[!is.na(fin_reg_df_annual$WGI_tot)]), collapse = "-")`. That means that inclusion of those variables comes at a cost of reducing sample size. For this reason I run several regressions, incrementaly adding the variables to the estimation equation. This process allows me to test the robustness of the results.



```{r output_panel_reg_controls, results="asis"}

temp_reg_list = reg_list$panel

temp_se_list = lapply(temp_reg_list,function(temp_plm){
                        return(sqrt(diag(vcovHC(temp_plm,cluster = "group"))))
                               })

temp_names = c("lag\\(bank_gdp, 1\\)","Crises","EU_both",
                   "lag\\(bank_gdp, 1\\):Crises")


stargazer(temp_reg_list, header = FALSE,
          label = "panel_reg_controls",table.placement = "H",
          title = "Panel specification with crises indicators and controls",
          dep.var.caption = "Fin cycle synch",
          model.numbers = FALSE,
          dep.var.labels.include = FALSE,
          column.labels = gsub("_","-", names(temp_reg_list)),
          notes = c("The table presents panel estimation that includes twoway",
                    " fixed effects and linear trend Each column referes to",
                    " subsample of countrypair groups"),
          notes.align = "l",
          notes.append = FALSE,
          se = temp_se_list,
          column.sep.width = "1pt",
          keep = paste0("^",temp_names,"$"),order = paste0("^",temp_names,"$"),
          covariate.labels = c("Bank linkages (lag)",
                               "Crises",
                               "EU country pair",
                               "Bank linkages (lag)*Crises"),
          omit.stat = c("f","adj.rsq"),
          add.lines = list(c("Controls",
                             rep("Yes", length(temp_reg_list))),
                           c("Year FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair linear trend",
                             rep("Yes", length(temp_reg_list)))))

rm(temp_se_list, temp_reg_list, temp_ind)


```


Table \ref{panel_reg_controls} shows the results of regression with only the crises effect included. There is no reliable identification of the association of bank linkages with financial cycles synchronization in normal times. Only in Low Income group the association is statisticly significant and negative while in other groups the results are statisticly insignificant  .This outcome is perhaps due to the opposite effects ("propagation" vs "absorption") that take place according to the literature. However I get a reliable identification of the association during crises periods. I find that banking integration is associated with more synchronized financial cycles meaning that banking integration's "shock propagating" feature is amplified during these periods. This result is stable across all the countries groups. In order to make sure that there is statisticly significant relationship I test (and reject) joint hypothesis $\beta + \gamma_{2} \leq 0$ and conclude that there is significant relationship.


```{r output_panel_reg_fd, results="asis"}

temp_reg_list = reg_list$panel_fd

temp_se_list = lapply(temp_reg_list,function(temp_plm){
                        return(sqrt(diag(vcovHC(temp_plm,cluster = "group"))))
                               })

temp_names = c("lag\\(bank_gdp, 1\\)","Crises","EU_both",
                   "lag\\(bank_gdp, 1\\):Crises","FD_tot",
                   "lag\\(bank_gdp, 1\\):FD_tot")

stargazer(temp_reg_list, header = FALSE,
          label = "panel_reg_FD",table.placement = "H",
          title = paste0("Panel with crises and",
                         " financial development indicators"),
          dep.var.caption = "Fin cycle synch",
          model.numbers = FALSE,
          dep.var.labels.include = FALSE,
          column.labels = gsub("_","-", names(temp_reg_list)),
          notes = "Clustered standard errors",
          se = temp_se_list,
          column.sep.width = "1pt",
          keep = paste0("^",temp_names,"$"),order = paste0("^",temp_names,"$"),
          covariate.labels = c("Bank linkages (lag)",
                               "Crises",
                               "EU country pair",
                               "Bank linkages (lag)*Crises",
                               "Financial Development",
                               "Bank linkages (lag)*FD"),
          omit.stat = c("f","adj.rsq"),
          add.lines = list(c("Controls",
                             rep("Yes", length(temp_reg_list))),
                           c("Year FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair linear trend",
                             rep("Yes", length(temp_reg_list)))))

rm(temp_se_list, temp_reg_list,temp_names)




```


Table \ref{panel_reg_FD} presents estimation results that include financial development data.


Financial development data is only available for 1980-2013 period so the estimation results in a loss of data. Nethertheless this estimation allows me to differentiate between the "single" effect of bank linkages and the effect of interaction with financial development. Controlling for financial development level shows that financial development is associated with more synchronized financial cycles but only among Hi Income group. That finding offers some support for the hypothesis that in advanced countries high level of financial development enables use of sophisticated financial instruments that can transmit common shocks. The interaction between bank linkages and financial development is positive in the Hi Income and Cross country pair groups and negative in Low Income group. A very interesting (and important result) is that once crises and financial development contributions are controlled for the association of Bank linkages (that is the effect of Bank linkages in normal times in countries with "basic" level of financial development) is negative namely that bank linkages are associated with less synchronized cycles. The crises effect is still significantly positive across all groups.




```{r output_panel_reg_fd_wgi, results="asis"}

temp_reg_list = reg_list$panel_fd_wgi

temp_se_list = lapply(temp_reg_list,function(temp_plm){
                        return(sqrt(diag(vcovHC(temp_plm,cluster = "group"))))
                               })

temp_names = c("lag\\(bank_gdp, 1\\)","Crises","EU_both",
                   "lag\\(bank_gdp, 1\\):Crises","FD_tot",
                   "lag\\(bank_gdp, 1\\):FD_tot","WGI_tot",
                   "lag\\(bank_gdp, 1\\):WGI_tot")

stargazer(temp_reg_list, header = FALSE,
          label = "panel_reg_FD_WGI",
          title = paste0("Panel with crises and",
                         " financial development and governance indicators"),
          dep.var.caption = "Fin cycle synch",
          model.numbers = FALSE,
          dep.var.labels.include = FALSE,
          column.labels = gsub("_","-", names(temp_reg_list)),
          notes = "Clustered standard errors",
          se = temp_se_list,
          column.sep.width = "1pt",
          keep = paste0("^",temp_names,"$"),
          order = paste0("^",temp_names,"$"),
          covariate.labels = c("Bank linkages (lag)",
                               "Crises",
                               "EU country pair",
                               "Bank linkages (lag)*Crises",
                               "Financial Development",
                               "Bank linkages (lag)*FD",
                               "Institutional Governance",
                               "Bank linkages (lag)*IG"),
          omit.stat = c("f","adj.rsq"),
          add.lines = list(c("Controls",
                             rep("Yes", length(temp_reg_list))),
                           c("Year FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair linear trend",
                             rep("Yes", length(temp_reg_list)))))

rm(temp_se_list, temp_reg_list, temp_names)




```


Now I add governance or institutional quality (such as corruption, rule of law and regulatory quality) indicators following a strand of literature that discuss the effects of institutional and cultural findamentals. The cost of the inclusion of this variable is yet another (small) reduction in the data availability. The results are presented in table \ref{panel_reg_FD_WGI}, governance indicator enter the equation with a negative sigh but the association is only significant in the All and Low Income groups. Since in this case the Low income dataset has only `r  nrow(reg_list$panel_fd_wgi$Weak$model)` observations and `r  length(reg_list$panel_fd_wgi$Weak$coefficients)` parameters there may be a danger of overfitting. The interaction term suggests that in countries with better insitutional quality the "shock absorbent" effect dominates. In this sample the crisis effect in Hi Income group is no longer significant (although the sign is still positive). Financial development effect remains significant only in All and Hi Income groups.


\subsection{1978 - 2006 period}

In this section I reduce my sample to 1978-2006 period. That serves several purposes : first it allows comparison between [@Kalemli-Ozcan2013JF] results with respect to business cycles synchronization and my results with respect to financial cycles synchronization. Second, this setting end before turmoil years that were characterized by the Global Financial Crises, the European sovereign debt crises and their aftermaths and enables to estimate the association between banking integration and financial cycles synchronization during "normal" times.

Table \ref{panel_reg_2007} present the estimation results. The crisis effect is no longer significant probably due to exclusion of major events such the Global Financial crisis and the European sovereign debt crisis. Table \ref{panel_reg_FD_2007} shows the results with financial development indicators included.In all but Low Income group the financial development effect is significant meaning that banking integration in highly developed markets is associated with more synchronized financial cycles. As in the full sample once financial development is accounted for the coefficients of banking linkages turn negative meaning that banking linkages are associated with less synchronized financial cycles. This finding supports the hypothesis about banking flows that serve as rebalancing mechanism. Table \ref{panel_reg_FD_WGI_2007} shows that once the governance indicators are add the results loose their significance but that may be due to large loss of observations (`r nrow(reg_list$panel_fd_2007$All$model)` in All group before governance addition vs `r nrow(reg_list$panel_fd_wgi_2007$All$model)`observations after).


```{r output_panel_reg_controls_2007, results="asis"}

temp_reg_list = reg_list$panel_2007

temp_se_list = lapply(temp_reg_list,function(temp_plm){
                        return(sqrt(diag(vcovHC(temp_plm,cluster = "group"))))
                               })

temp_names = c("lag\\(bank_gdp, 1\\)","Crises","EU_both",
                   "lag\\(bank_gdp, 1\\):Crises")


stargazer(temp_reg_list, header = FALSE,
          label = "panel_reg_2007",
          table.placement = "H",
          title = "Panel with crises indicators, 1978-2006 sample",
          dep.var.caption = "Fin cycle synch",
          dep.var.labels.include = FALSE,
          model.numbers = FALSE,
          column.labels = gsub("_","-", names(temp_reg_list)),
          notes = "Clustered standard errors",
          se = temp_se_list,
          column.sep.width = "1pt",
          keep = paste0("^",temp_names,"$"),order = paste0("^",temp_names,"$"),
          covariate.labels = c("Bank linkages (lag)",
                               "Crises",
                               "EU country pair",
                               "Bank linkages (lag)*Crises"),
          omit.stat = c("f","adj.rsq"),
          add.lines = list(c("Controls",
                             rep("Yes", length(temp_reg_list))),
                           c("Year FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair linear trend",
                             rep("Yes", length(temp_reg_list)))))

rm(temp_se_list, temp_reg_list, temp_ind)


```



```{r output_panel_reg_fd_2007, results="asis"}

temp_reg_list = reg_list$panel_fd_2007

temp_se_list = lapply(temp_reg_list,function(temp_plm){
                        return(sqrt(diag(vcovHC(temp_plm,cluster = "group"))))
                               })

temp_names = c("lag\\(bank_gdp, 1\\)","Crises","EU_both",
                   "lag\\(bank_gdp, 1\\):Crises","FD_tot",
                   "lag\\(bank_gdp, 1\\):FD_tot")

stargazer(temp_reg_list, header = FALSE,
          label = "panel_reg_FD_2007",table.placement = "H",
          title = paste0("Panel with crises and",
                         " financial development indicators, 1978-2006 sample"),
          dep.var.caption = "Fin cycle synch",
          dep.var.labels.include = FALSE,
          column.labels = gsub("_","-", names(temp_reg_list)),
          model.numbers = FALSE,
          notes = "Clustered standard errors",
          se = temp_se_list,
          column.sep.width = "1pt",
          keep = paste0("^",temp_names,"$"),order = paste0("^",temp_names,"$"),
          covariate.labels = c("Bank linkages (lag)",
                               "Crises",
                               "EU country pair",
                               "Bank linkages (lag)*Crises",
                               "Financial Development",
                               "Bank linkages (lag)*FD"),
          omit.stat = c("f","adj.rsq"),
          add.lines = list(c("Controls",
                             rep("Yes", length(temp_reg_list))),
                           c("Year FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair linear trend",
                             rep("Yes", length(temp_reg_list)))))

rm(temp_se_list, temp_reg_list,temp_names)




```



```{r output_panel_reg_fd_wgi_2007, results="asis"}

temp_reg_list = reg_list$panel_fd_wgi_2007

temp_se_list = lapply(temp_reg_list,function(temp_plm){
                        return(sqrt(diag(vcovHC(temp_plm,cluster = "group"))))
                               })

temp_names = c("lag\\(bank_gdp, 1\\)","EU_both","FD_tot",
                   "lag\\(bank_gdp, 1\\):FD_tot","WGI_tot",
                   "lag\\(bank_gdp, 1\\):WGI_tot")

stargazer(temp_reg_list, header = FALSE,
          label = "panel_reg_FD_WGI_2007",
          title = paste0("Panel with crises and",
                         " financial development and governance indicators",
                         "1978-2006 sample"),
          dep.var.caption = "Fin cycle synch",
          model.numbers = FALSE,
          dep.var.labels.include = FALSE,
          column.labels = gsub("_","-", names(temp_reg_list)),
          notes = "Clustered standard errors",
          se = temp_se_list,
          column.sep.width = "1pt",
          keep = paste0("^",temp_names,"$"),
          order = paste0("^",temp_names,"$"),
          covariate.labels = c("Bank linkages (lag)",
                               "EU country pair",
                               "Financial Development",
                               "Bank linkages (lag)*FD",
                               "Institutional Governance",
                               "Bank linkages (lag)*IG"),
          omit.stat = c("f","adj.rsq"),
          add.lines = list(c("Controls",
                             rep("Yes", length(temp_reg_list))),
                           c("Year FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair FE",
                             rep("Yes", length(temp_reg_list))),
                           c("Country-pair linear trend",
                             rep("Yes", length(temp_reg_list)))))

# rm(temp_se_list, temp_reg_list, temp_names)




```

\section{Summary and conclusions} \label{conclusions}

This paper studies the effect of banking integration on synchronization of financial cycles. There are opposite effects ("shock absorption" vs "shock propagation") that make the identification of this effect difficult. I find that financial crises and financial development increase the "shock propagation" feature of banking integration while institutional quality increase the "shock absorption" feature. I find limited evidence of negative association between banking integration and financial cyles synchronization, this finding paralles the results of [@Kalemli-Ozcan2013JF] that find that banking integration causes business cycles divergence. An important question is whether my findings can be given causal interpretaion. My specification includes variables to control for 
other economic factors that can bias the identification and lagged banking linkages to deal with reverse causality. To the extent these measures adequately address the endogeineity issue causal interpretaion can be assigned.


\newpage

\section{Appendix}



<!-- \subsection{Delta estimation} -->


\subsection{Explanatory variables}

\textbf{Total credit}
Importantly, the data account for credit from all sources, not only that extended by domestic banks. Total credit from financial accounts, domestic bank credit and cross-border bank credit are the three main building blocks underlying the construction of the total credit series. Trade credit (as well as other accounts payable and receivable) is excluded from the new total credit series because the quality of the underlying data is globally poor.In principle, nominal values are used for loans, corresponding to the origination price (historical cost) plus the interest that has accrued but not been paid if there has not been a default.  All other financial assets, including debt securities, are in principle valued at market prices. In practice, though, debt securities are often reported at nominal value. This may affect international comparability in cases of large volumes of debt securities and large price swings, but is impossible to adjust for. As a rule, the total credit series are not adjusted for exchange rate movements. This correction is only possible for the international banking statistics where a currency breakdown is available, but would be highly artificial for the long-run series.


\textbf{Property prices}
I use data about residential property prices (RPP) from BIS selected residential property prices data set. The selected residential property prices are harmonised as much as possible with recommendations in the Handbook on residential property prices, an internationally agreed framework for classifying property price issues.

\textbf{Bank linkages}
This variable is based on bilateral cross-border holdings (stocks) of banks. Data on banks’ cross-border bilateral stocks of assets and liabilities come from BIS’s Locational Banking Statistics.For each country pair and year there are up to four observations: i) asset holdings (stocks) of banks located in country i in all sectors of the economy in country j, ii) asset holdings (stocks) of banks located in country j in all sectors of the economy in country i, iii) liabilities (stocks) of banks located in country i to country j, and iv) liabilities (stocks) of banks located in country j to country i. The data are originally expressed in current U.S. dollars. I normalize the data with the following steps:

\begin{enumerate}
  \item
  Deflate the four series with the U.S. CPI index
  
  \item
  Standardize the series by dividing assets and liabilities by the sum of the
two countries’ GDP in each year (using data from World Bank’s World
Development Indicators).

  \item
  Take the average of the log value of real bilateral assets and liabilities in each year.

\end{enumerate}


\textbf{Trading linkages} indicate of bilateral trade intensity. The measure is the log of bilateral real (deflated with the U.S. price deflator) exports and imports as a share of the two countries’ GDP. Source: IMF Direction of Trade Database (2008).

\textbf{Monetary Independence},\textbf{Financial openness} and \textbf{FX stability} indices are based on the work of [@Chinn2010].


Exchange Rate Stability (\textbf(FX stab))

To measure exchange rate stability, annual standard deviations of the monthly exchange rate
between the home country and the base country are calculated and included in the following
formula to normalize the index between 0 and 1:

$ERS = \frac{0.01}{0.01 + SD(\Delta(log(FX)))}$

Merely applying this formula can easily create a downward bias in the index, that is, it would exaggerate the “flexibility” of the exchange rate especially when the rate usually follows a narrow band, but is de- or revalued infrequently.To avoid such downward bias, we a threshold to the exchange rate movement is applyed. That is, if the rate of
monthly change in the exchange rate stayed within +/-0.33 percent bands, the
exchange rate is considered “fixed” and the value of one is assigned for the ERS index. Furthermore, single year pegs are dropped because they are quite possibly not intentional ones. Higher values of this index indicate more stable movement of the exchange rate against the currency of the base country.


Financial openness/ Integration (\textbf{KAOPEN}) 

Financial openness measure is based on the index of capital account openness or KAOPEN, by [@Chinn2006]. KAOPEN is the first standardized principal component of the variables that indicate the presence of multiple exchange rates, restrictions on current account transactions, on capital account transactions, and the requirement of the surrender of export proceeds. The index is normalized between zero and one. Higher values of this index indicate that a country is more open to cross-border capital transactions.


\textbf{Harmonization index}

The steps to constructing the instrumental variable (Harmon_both_Index) are:

\begin{enumerate}
  \item
  Define (27) indicator variables that equal one if in any given year both countries in each countrypair cell have transposed the Directive into national law and zero otherwise.
$LEX^{k}_{i,j,t} = \begin{cases} \text{1 if \textit{i,j} transposed at t} \\\text{ 0 otherwise} \end{cases}$
  

\end{enumerate}

<!-- \textbf{Fin_synch}  -->

The synchronization measure that I used is the negative of divergence in growth rates defined as the abosulte value of Fin Cycle growth differences between country i and country j in period t.

\begin{equation*}
FinSynch_{i,j,i} = -\lvert (Y_{i,t} - Y_{i,t-1}) - (Y_{j,t} - Y_{j,t-1}) \rvert
\end{equation*}

where:

\begin{equation*}
Y_{i,t} = 0.5 \cdot ln \left(  \frac{TotalCredit_{t}}{TotalCredit_{t-1}} \right) 
+0.5 \cdot ln\left( \frac{HousePrice_{t}}{HousePrice_{t-1}} \right) 
\end{equation*}	
	

\textbf{Governance} The Worldwide Governance Indicators (WGI) project reports aggregate and individual governance indicators for over 200 countries and territories over the period 1996–, for six dimensions of governance:

\begin{itemize}
  \item
  Voice and Accountability  
  \item
  Political Stability and Absence of Violence
  \item
  Government Effectiveness
  \item
  Regulatory Quality
  \item
  Rule of Law
  \item
  Control of Corruption
\end{itemize}

These aggregate indicators combine the views of a large number of enterprise, citizen and expert survey respondents in industrial and developing countries.  They are based on over 30 individual data sources produced by a variety of survey institutes, think tanks, non-governmental organizations, international organizations, and private sector firms. Higher values of the indicators correspond to better outcomes.

\section{Bibliography}


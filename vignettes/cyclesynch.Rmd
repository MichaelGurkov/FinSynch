---
title: "CycleSynch"
author: "Michael Gurkov"
date: "`r Sys.Date()`"
output:
  rmarkdown::pdf_document:
    latex_engine: xelatex
    number_sections: true
    keep_tex: true
bibliography: C:\\Users\\Misha\\Documents\\References\\Financial_Cycle-Global_Financial_Cycle.bib

vignette: >
  %\VignetteIndexEntry{CycleSynch}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,echo = FALSE,
  message = FALSE,warning = FALSE,cache = TRUE,
  comment = "#>"
)
```


```{r load_package}

devtools::load_all()

library(ggplot2)

library(foreign)

library(plm)

library(stargazer)

library(sandwich)

library(clubSandwich)

library(lmtest)

library(purrr)

```


```{r params_setup}

oecd_countries_vec = c("Australia","Austria","Belgium","Canada","Chile",
                  "Czech_Republic","Denmark","Estonia","Finland","France",
                  "Germany","Greece","Hungary", "Iceland","Ireland",
                  "Israel","Italy","Japan","Korea","Latvia",
                  "Lithuania","Luxembourg","Mexico","Netherlands",
                  "New_Zealand","Norway","Poland","Portugal",
                  "Slovak_Republic","Slovenia","Spain","Sweden",
                  "Switzerland","Turkey","United_Kingdom"
                  ,"United_States")

strong_countries = c("Australia","Austria","Belgium","Canada",
                  "Switzerland","Germany","Denmark","Spain",
                  "Finland","France","United_Kingdom","Ireland",
                  "Italy","Japan","Netherlands","Portugal",
                  "Sweden","United_States")

weak_countries = oecd_countries_vec[!oecd_countries_vec %in% strong_countries]


strong_countries_pairs = apply(combn(strong_countries,2), 2,
                        function(temp_col){
                          ifelse(temp_col[1]<temp_col[2],
                                 paste(temp_col[1],temp_col[2],sep = "-"),
                                 paste(temp_col[2],temp_col[1],sep = "-"))})

weak_countries_pairs = apply(combn(weak_countries,2), 2,
                        function(temp_col){
                          ifelse(temp_col[1]<temp_col[2],
                                 paste(temp_col[1],temp_col[2],sep = "-"),
                                 paste(temp_col[2],temp_col[1],sep = "-"))})

oecd_countries_pairs = apply(combn(oecd_countries_vec,2), 2,
                        function(temp_col){
                          ifelse(temp_col[1]<temp_col[2],
                                 paste(temp_col[1],temp_col[2],sep = "-"),
                                 paste(temp_col[2],temp_col[1],sep = "-"))})

cross_country_pairs = oecd_countries_pairs[!oecd_countries_pairs %in% strong_countries_pairs & !oecd_countries_pairs %in% weak_countries_pairs]


```


```{r Import_data}


wdi_data = import_wdi_df(NULL,countries_vec = oecd_countries_vec) %>%
  rename(Date = Year) %>% 
  mutate_at(.,vars(starts_with("GDP")),.funs = list(~./1000)) %>% 
  deflate.data(.,vars_to_deflate = "GDP") %>% 
  deflate.data(.,vars_to_deflate = "GDP_per_Capita") %>% 
  select(-GDP,-GDP_per_Capita )


bis_data = import_bis_fin_cycle_df(filepath_list = list(
                         Total_credit =
                           paste0("C:\\Users\\Misha\\Documents\\Data\\",
                                  "BIS\\temp_tot_credit_BIS.rds"),
                         House =
                           paste0("C:\\Users\\Misha\\Documents\\Data\\",
                                  "BIS\\temp_house_bis.rds")),
                         countries_vec = oecd_countries_vec) %>% 
  group_by(Country, Date = format(Date, "%Y")) %>% 
  summarise_all(.,.funs = mean, na.rm = TRUE) %>%
  deflate.data(.,vars_to_deflate = "TotalCredit") %>% 
  select(-TotalCredit)

df = full_join(wdi_data, bis_data)

df = df %>% 
  filter(Date >=1978 & Date <= 2017) %>% 
  group_by(Country) %>% 
  mutate_at(.vars = c("GDP_per_Capita_real",
                      "GDP_real", "TotalCredit_real",
                           "HousePrice"),
            .funs = list(ret = ~c(NA,diff(log(.))))) %>% 
  mutate_at(.vars = c("TotalCredit_real","HousePrice"),
            .funs = list(fin_cycle = ~ get.clean.cycle(.,filter = "cf"))) %>%
  mutate(GDP_per_Capita_real_cycle = get.clean.cycle(
    GDP_per_Capita_real,my_pl = 2,my_pu = 8)) %>%
  mutate(Fin_ret = rowMeans(data.frame(TotalCredit_real_ret,
                                      HousePrice_ret),na.rm = TRUE),
         Fin_cycle = rowMeans(data.frame(TotalCredit_real_fin_cycle,
                                      HousePrice_fin_cycle),na.rm = TRUE)) %>% 
  select(Country, Date, Pop, GDP_per_Capita_real,GDP_real,GDP_real_ret,
         GDP_per_Capita_real_ret,Fin_ret)

rm(wdi_data, bis_data)

```


```{r Import_IMF_Data}

export_df = lapply(list.files(paste0("C:\\Users\\Misha\\Documents\\Data",
                                     "\\IMF\\Export-Import\\Export"),
                              full.names = TRUE),
                   import_imf_df,
                   countries_vec = oecd_countries_vec) %>% 
  bind_rows() %>% 
  mutate(Exports = as.numeric(Exports)) %>% 
  group_by(Date, CountryPair) %>% 
  summarise(Exports = sum(Exports, na.rm = TRUE))


import_df = lapply(list.files(paste0("C:\\Users\\Misha\\Documents\\Data",
                                     "\\IMF\\Export-Import\\Import"),
                              full.names = TRUE),
                   import_imf_df,
                   countries_vec = oecd_countries_vec) %>% 
  bind_rows() %>% 
  mutate(Imports = as.numeric(Imports)) %>%
  group_by(Date, CountryPair) %>% 
  summarise(Imports = sum(Imports, na.rm = TRUE))

trade_df = full_join(export_df,import_df) %>% 
  gather(.,key = Balance_Pos, value = Trade, -Date, - CountryPair) %>% 
  deflate.data(.,vars_to_deflate = "Trade") %>% 
  select(-Trade)


trade_gdp = trade_df %>%
  ungroup() %>% 
  normalize.imf.data(.,wdi_df = df[,c("Date","Country", "GDP_real")],
                     norm_val = "GDP_real") %>%
  group_by(Date, CountryPair) %>%
  summarise(trade_gdp = mean(log(Trade_real), na.rm = TRUE)) %>%
  filter(!is.na(trade_gdp)) %>% 
  filter(is.finite(trade_gdp))

rm(export_df, import_df, trade_df)



```


```{r Import_trilemma_data}

df = left_join(df, import.trilemma.ind(),
               by = c("Country","Date"))

```


```{r Import_macroprudata, eval=FALSE}

df = left_join(df, import.macropru.ind(),
               by = c("Country","Date"))



```


```{r Import_fin_development_data}

df = left_join(df, import.fin.dev.ind(),
               by = c("Country","Date"))



```


```{r calculate_bank_integration_measures, cache=FALSE}


bank_balance_norm = import_cross_border_balance(NULL,
                                   countries_vec = oecd_countries_vec) %>% 
  deflate.data(.,vars_to_deflate = "Balance") %>%
  select(Date, CountryPair,Balance_Pos, Balance_real) %>%
  normalize.bis.data(.,norm_df = df[,c("Date","Country", "GDP_real")],
                     norm_val = "GDP_real")


bank_gdp = bank_balance_norm %>% 
  group_by(Date, CountryPair) %>%
  summarise(bank_gdp = mean(log(Balance_real), na.rm = TRUE)) %>%
  filter(!is.na(bank_gdp))



```


```{r make_fin_reg_df}

fin_reg_df = construct_fin_reg(df)

```


\section{Introduction}



\section{Literature review}

[@Avdjiev2019] study the factors that affect lending behavior of global banksâ€™ subsidiaries throughout the world. The authors divide the influencing factors to two groups: "push" (global drivers) factors and "pull" factors such as macroeconomic conditions that measure the local cost of funding and the strength of the borrowers' balance sheets and the financial conditions of the global bank's subsidiaries.The authors find that hat the lending behavior of the subsidiaries is more closely related to local macroeconomic conditions and their financial conditions than to those of their owner-specific counterparts namely that the "pull" factors are more important relative to "push" factors. From financial stability point of view the "push" factors increase synchronization (a.k.a contagion) while the "pull" factors should reduce synchronization due to idiosynchratic shocks.

[@Kalemli-Ozcan2013] use absolute value of GDP growth difference as a robust (not subject to filtering technique critique) synchronization measure. The reseachers show that banking integration is negatively associated with output cycle synchronization. Another interesting finding is that the association becomes more positive in the times of fnancial crisys.


\section{Descriptive Statistics}

```{r country_table_summary, results="asis"}

table_list = list(df %>%
                    ungroup() %>%
                    select(GDP_per_Capita_real, FX_stab, FD, FI) %>% 
                    as.data.frame(),
                  df %>%
                    ungroup() %>%
                    filter(Country %in% strong_countries) %>%
                    select(GDP_per_Capita_real, FX_stab, FD, FI) %>% 
                    as.data.frame(),
                  df %>%
                    ungroup() %>%
                    filter(Country %in% weak_countries) %>%
                    select(GDP_per_Capita_real, FX_stab, FD, FI) %>% 
                    as.data.frame())




stargazer(table_list,
          header =FALSE, summary = rep(TRUE,3),
          title = c("All","Strong","Weak"),
          summary.stat = c("max","min","mean","median","sd","n"))

rm(table_list)

```

Table present the descriptive statistics of the two (Strong and Weak) samples.
We can see that the Strong sample is characterized by higher (on average) GDP per capita and higher financial oppeness and development indicators.


```{r countrypair_table_summary, results="asis"}

table_list = list(fin_reg_df %>%
                    ungroup() %>%
                    select(bank_gdp,trade_gdp,FX_stab_tot,FO_ind_tot,
                           FD_tot,MI_ind_tot) %>% 
                    as.data.frame(),
                  fin_reg_df %>%
                    ungroup() %>%
                    filter(CountryPair %in% strong_countries_pairs) %>%
                    select(bank_gdp,trade_gdp,FX_stab_tot,FO_ind_tot,
                           FD_tot,MI_ind_tot) %>% 
                    as.data.frame(),
                  fin_reg_df %>%
                    ungroup() %>%
                    filter(CountryPair %in% weak_countries_pairs) %>%
                    select(bank_gdp,trade_gdp,FX_stab_tot,FO_ind_tot,
                           FD_tot,MI_ind_tot) %>% 
                    as.data.frame())




stargazer(table_list,
          header =FALSE, summary = rep(TRUE,3),
          title = c("All","Strong","Weak"),
          summary.stat = c("max","min","mean","median","sd","n"))

rm(table_list)

```

The same characteristics are present at the country-pair level : the strong country pairs are more financialy developed.

\section{Financial cycle synchronization}

This section deals with synchronization of Financial cycles across countries.The main result of this section is that cross section ("Between") model estimates \textbf{positive} association between Credit cycle synchronization and financial integration. The estimation of panel ("Within") model with time and country fixed effect provides \textbf{negative} association.


```{r plot_between_model}

ggplot(fin_reg_df %>% 
         select(CountryPair, Fin_ret, bank_gdp) %>% 
         group_by(CountryPair) %>% 
         summarise_all(.,.funs = list(.~mean), na.rm = TRUE),
       aes(x = bank_gdp, y = Fin_ret * 100,
           color = ifelse(CountryPair %in% strong_countries_pairs,
                         "Strong countrypairs","Other"))) + 
  geom_point() + 
  geom_smooth(method = "lm",se = FALSE) +
  theme_bw() + 
  labs(title = paste0("Average synchronization of financial growth rates",
                      "\n (Between countrypairs)"),
       y = "Growth rate negative difference (percent)",
       x = "Cross border bank balance to gdp") + 
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.title = element_blank())


```


```{r plot_within_model}

plot_countrypair = "Canada-Netherlands"

ggplot(fin_reg_df %>% 
         filter(CountryPair == plot_countrypair),
       aes(x = bank_gdp, y = Fin_ret * 100)) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  theme_bw() + 
  labs(title = paste0("Average synchronization of financial growth rates",
                      "\n (Within ",plot_countrypair,")"),
       y = "Growth rate negative difference (percent)",
       x = "Cross border bank balance to gdp") + 
  theme(plot.title = element_text(hjust = 0.5))

rm(plot_countrypair)

```


\section{Regression analysis}

```{r fin_reg_calculate}

fin_reg_list = lapply(list(NULL,
                           strong_countries_pairs,
                           weak_countries_pairs,
                           cross_country_pairs,
                           c(cross_country_pairs, weak_countries_pairs)),
                      function(temp_vec){
                        
                        form = formula(Fin_ret ~ bank_gdp + trade_gdp +
                                                FO_ind_tot + FX_stab_tot + 
                                                FD_tot + MI_ind_tot)
                        
                        reg_df = fin_reg_df %>% 
                          {if(!is.null(temp_vec)) filter(.,CountryPair %in%
                                                           temp_vec) else .}

                        temp_reg = plm(formula = form,
                            model = "within",effect = "twoways",
                            data = reg_df,index = c("CountryPair","Date"))
                        
                        return(temp_reg)
                        
                        })


```


```{r output_fin_reg, results="asis"}

cov_labs = c("Banking linkages", "Trading linkages",
                               "Financial Openess","FX stability",
                               "Financial Development",
                               "Monetary Independence")

omit_vars = c("FO_ind_tot","FX_stab_tot","FD_tot","MI_ind_tot")

stargazer(fin_reg_list, header = FALSE, dep.var.labels = c("","","","",""),
          column.labels = c("All","Strong","Weak","Cross","Cross and Weak"),
          covariate.labels = cov_labs[1:2],omit = omit_vars,
          column.sep.width = "2pt",omit.stat = c("f","adj.rsq"),
          add.lines = list(c("Country pair FE",
                             rep("Yes",5)),
                           c("Year FE",
                             rep("Yes",5))))



# stargazer(fin_reg_list, header = FALSE, dep.var.labels = c("","","","",""),
#           column.labels = c("All","Strong","Weak","Cross","Cross and Weak"),
#           covariate.labels = cov_labs,
#           column.sep.width = "2pt",omit.stat = c("f","adj.rsq"))


```


\newpage

\subsection{Credit direction test}

In this subsection I test the hypothesis that the mechanism that results in credit cycle divergence is the movement of funds from "bad" to "good" country. I calculate the net credit balance between two countries, larger net balance should be associated with lower synchronization.


```{r make_net_credit_df}

credit_net_df = bank_balance_norm %>% 
  filter(Balance_Pos == "Total claims") %>%
  group_by(Date, CountryPair) %>% 
  summarise(NetCredit = ifelse(length(diff(Balance_real)) ==1,
                                diff(Balance_real),Balance_real)) %>% 
  inner_join(.,fin_reg_df %>% 
               select(Date, CountryPair, Fin_ret),
             by = c("Date","CountryPair")) %>% 
  ungroup() %>% 
  filter(complete.cases(.))

names(credit_net_df) = c("Date","CountryPair","Credit","Synch")

net_credit_reg = plm(formula("Synch~Credit"),data = credit_net_df,
                     model = "within",effect = "twoways",
                     index = c("CountryPair","Date"))

```


```{r ouput_net_credit_reg, results="asis"}

stargazer(net_credit_reg, header = FALSE,
          dep.var.labels = "Credit cycle synch")

```


```{r make_credit_dir_data, eval=FALSE}


credit_flows_df = readRDS(paste0("C:\\Users\\Misha\\Documents\\Data\\BIS",
                                          "\\temp_credit_flows.rds")) %>%
  filter(Country %in% oecd_countries_vec) %>%
  filter(Counter_Country %in% oecd_countries_vec) %>%
  rename(Balance_Pos = Balance.sheet.position) %>%
  mutate(Date = format(Date,"%Y")) %>% 
  group_by(Date, Country,Counter_Country,Balance_Pos) %>% 
  summarise(Avg_Val = mean(Flow_Val, na.rm = TRUE)) %>% 
  ungroup()


real_credit_flows_df = credit_flows_df %>% 
  deflate.data(.,vars_to_deflate = "Avg_Val") %>% 
  unite(.,CountryPair,sep = "-", Country, Counter_Country) %>% 
  select(-Avg_Val)

norm_credit_data = real_credit_flows_df %>%
  normalize.bis.data(.,wdi_df = df[,c("Date","Country", "GDP_real")],
                     norm_val = "GDP_real") %>% 
  group_by(Date, CountryPair) %>% 
  summarise(Avg_Val_real = sum(Avg_Val_real, na.rm = TRUE)) %>% 
  ungroup() %>% 
  separate(.,col = CountryPair, into = c("Country_A","Country_B"),
           sep = "-")
  


credit_dir_df = fin_reg_df %>% 
  select(Date, CountryPair, Fin_ret) %>% 
  separate(.,col = CountryPair, into = c("Country_A","Country_B"),
           sep = "-") %>% 
  left_join(.,norm_credit_data,
                          by = c("Country_A" = "Country_A",
                                 "Country_B" = "Country_B",
                                 "Date" = "Date")) %>% 
  left_join(.,norm_credit_data,
                          by = c("Country_A" = "Country_B",
                                 "Country_B" = "Country_A",
                                 "Date" = "Date"), 
            suffix = c("_in","_out")) %>% 
  unite(.,CountryPair,sep = "-",Country_A, Country_B) %>% 
  select(Date, CountryPair,Fin_ret,Avg_Val_real_in,Avg_Val_real_out)


credit_dir_df = pdata.frame(credit_dir_df,index = c("CountryPair","Date"))


```


```{r output_credit_dir_reg, results="asis", eval=FALSE}

stargazer(plm(formula = formula("Fin_ret~Avg_Val_real_in + Avg_Val_real_out"),
            data = credit_dir_df,effect = "twoways",model = "within"),
          header = FALSE,dep.var.labels = "")


```


\newpage

\section{Appendix}


\subsection{Robustness check}

Since the synch and bank_XXX measures both have credit component I use trade flows instead of bank 

```{r, eval=FALSE}

fin_trade_reg = plm(Fin_ret ~ trade_gdp + 
                FX_stab_tot + FO_ind_tot + 
                Pruc_tot + kaopen,
                   data = fin_reg_full_df, model = "within",
                   effect = "twoways")

stargazer(fin_trade_reg,
          title = "Robustness - trade instead of bank",
          header = FALSE, dep.var.labels.include = FALSE,
          omit.stat = "f",
          column.labels = "Synch1")



```


\subsubsection{Lag estimation}

```{r lag_estimation, eval=FALSE}

fin_reg_lag_list = lapply(list(NULL,
                           strong_countries_pairs,
                           weak_countries_pairs,
                           cross_country_pairs,
                           c(cross_country_pairs,
                             weak_countries_pairs)),
                      function(temp_vec){
                        
                        form = formula(Fin_ret ~ lag(bank_gdp) + trade_gdp +
                                                FO_ind_tot + FX_stab_tot + 
                                                FD_tot + MI_ind_tot)
                        
                        reg_df = fin_reg_df %>% 
                          {if(!is.null(temp_vec)) filter(.,CountryPair %in%
                                                           temp_vec) else .}

                        temp_reg = plm(formula = form,
                            model = "within",effect = "twoways",
                            data = reg_df,index = c("CountryPair","Date"))
                        
                        return(temp_reg)
                        
                        })

```


```{r lag_output, results="asis", eval=FALSE}

stargazer(fin_reg_lag_list, header = FALSE,
          dep.var.labels = c("","","","",""),
          column.labels = c("All","Strong","Weak","Cross","Cross and Weak"),
          column.sep.width = "2pt",omit.stat = c("f","adj.rsq"))


```

\subsubsection{Instrument variable estimation}

The Financial Services Action Plan (FSAP) took place amoung EU15 countries during 1998-2008. The purpose of this major policy initiative was to remove regulatory and legislative barriers in financial intermediation across European countries. 

```{r harmon_index, eval=FALSE}

fsap_countries = c("Austria","Belgium","Germany","Denmark","Spain",
                   "France","Finland","Greece","Ireland","Italy",
                   "Luxembourg","Netherlands","Portugal",
                   "Sweden","United Kingdom")

cpi_quarter = import.bis.cpi.data(my_freq = "Monthly",
                          my_regex = "^X\\d{4}\\.\\d{2}$") %>% 
  mutate(Date = as.Date(paste(sub("\\.","-",Date),"01",sep = "-"))) %>% 
  mutate(Date = as.yearqtr(Date)) %>% 
  group_by(Date) %>% 
  summarise(US_CPI = mean(US_CPI, na.rm = TRUE))


oecd_gdp_real = import.oecd.gdp() %>% 
  rename(GDP = Value) %>% 
  deflate.data(.,vars_to_deflate = "GDP",cpi = cpi_quarter)

bank_cross_gdp_quarter = import_cross_border_balance(NULL,
                                   countries_vec = fsap_countries,
                                   annual_freq = FALSE) %>% 
  deflate.data(.,cpi = cpi_quarter,vars_to_deflate = "Balance") %>%
  select(Date, CountryPair,Balance_Pos, Balance_real) %>%
  normalize.bis.data(.,norm_df = oecd_gdp_real[,c("Date","Country", "GDP_real")],
                     norm_val = "GDP_real") %>% 
  group_by(Date, CountryPair) %>%
  summarise(bank_gdp = mean(log(Balance_real), na.rm = TRUE)) %>%
  filter(!is.na(bank_gdp))


harmon_index = import.harmon.data() %>% 
  construct_countrypair_harmon_index() %>% 
  group_by(CountryPair, Date) %>% 
  summarise(Harmon_Index = log(sum(Transposed + 1, na.rm = TRUE)))


first_stage_reg = plm(formula(bank_gdp ~ Harmon_Index),
                      data = inner_join(bank_cross_gdp_quarter,
                                        harmon_index,
                                        by = c("CountryPair","Date")) %>% 
                        ungroup() %>% 
                        mutate(Date = as.Date(Date)),
                      model = "within", effect = "twoways",
                      index = c("CountryPair","Date"))


iv_df = full_join(fin_reg_df, harmon_index, by = c("CountryPair","Date"))


aux_fin_reg = plm(formula = formula(Fin_ret ~ Harmon_Index + trade_gdp +
                                     FO_ind_tot + FX_stab_tot + 
                                     FD_tot + MI_ind_tot),
                 index = c("CountryPair","Date"),
                 data = iv_df,
                 model = "within",effect = "twoways")

iv_fin_reg = plm(formula = formula(Fin_ret ~ bank_gdp + trade_gdp +
                                     FO_ind_tot + FX_stab_tot + 
                                     FD_tot + MI_ind_tot| .- bank_gdp + Harmon_Index),
                 index = c("CountryPair","Date"),
                 data = iv_df,
                 model = "within",effect = "twoways")
  

```


\subsection{Financial cycle synch - sensitivity}

```{r run_min_and_diff_specs}

fin_reg_list_diff = lapply(list(NULL,
                           strong_countries_pairs,
                           weak_countries_pairs,
                           cross_country_pairs,
                           c(cross_country_pairs, weak_countries_pairs)),
                      function(temp_vec){
                        
                        form = formula(Fin_ret ~ bank_gdp + trade_gdp +
                                                FO_ind_diff + FX_stab_diff + 
                                                FD_diff + MI_ind_diff)
                        
                        reg_df = fin_reg_df %>% 
                          {if(!is.null(temp_vec)) filter(.,CountryPair %in%
                                                           temp_vec) else .}

                        temp_reg = plm(formula = form,
                            model = "within",effect = "twoways",
                            data = reg_df)
                        
                        return(temp_reg)
                        
                        })


fin_reg_list_min = lapply(list(NULL,
                           strong_countries_pairs,
                           weak_countries_pairs,
                           cross_country_pairs,
                           c(cross_country_pairs, weak_countries_pairs)),
                      function(temp_vec){
                        
                        form = formula(Fin_ret ~ bank_gdp + trade_gdp +
                                                FO_ind_min + FX_stab_min + 
                                                FD_min + MI_ind_min)
                        
                        reg_df = fin_reg_df %>% 
                          {if(!is.null(temp_vec)) filter(.,CountryPair %in%
                                                           temp_vec) else .}

                        temp_reg = plm(formula = form,
                            model = "within",effect = "twoways",
                            data = reg_df)
                        
                        return(temp_reg)
                        
                        })

```


```{r output_fin_reg_diff_min, results="asis"}

stargazer(fin_reg_list_diff, header = FALSE, dep.var.labels = c("","","","",""),
          column.labels = c("All","Strong","Weak","Cross","Cross and Weak"),
          column.sep.width = "2pt",omit.stat = c("f","adj.rsq"))


stargazer(fin_reg_list_min, header = FALSE, dep.var.labels = c("","","","",""),
          column.labels = c("All","Strong","Weak","Cross","Cross and Weak"),
          column.sep.width = "2pt",omit.stat = c("f","adj.rsq"))

```



```{r incremental_regressions}

form_list = list(formula(Fin_ret ~ bank_gdp + trade_gdp + FO_ind_tot),
                 formula(Fin_ret ~ bank_gdp + trade_gdp + 
                                  FO_ind_tot + FX_stab_tot),
                 formula(Fin_ret ~ bank_gdp + trade_gdp + 
                                  FO_ind_tot + FD_tot),
                 formula(Fin_ret ~ bank_gdp + trade_gdp + 
                                  FO_ind_tot + FX_stab_tot + FD_tot),
                 formula(Fin_ret ~ bank_gdp + trade_gdp + 
                                  FO_ind_tot + FX_stab_tot
                         + FD_tot + MI_ind_tot))

oecd_reg_list = lapply(form_list,
                  function(temp_form){plm(formula = temp_form,
                      data = fin_reg_df, model = "within",
                     effect = "twoways",
                     index = c("CountryPair","Date"))})

strong_reg_list = lapply(form_list,
                  function(temp_form){plm(formula = temp_form,
                      data = fin_reg_df %>% 
                        filter(CountryPair %in% strong_countries_pairs),
                      model = "within",
                     effect = "twoways",
                     index = c("CountryPair","Date"))})

weak_reg_list = lapply(form_list,
                  function(temp_form){plm(formula = temp_form,
                      data = fin_reg_df %>% 
                        filter(CountryPair %in% weak_countries_pairs),
                      model = "within",
                     effect = "twoways",
                     index = c("CountryPair","Date"))})

```


```{r Output_panel_reg_fin, results="asis"}

stargazer(strong_reg_list,
          header = FALSE, omit.stat = "f",
          title = "Strong sample (18 countries)",
          dep.var.labels = c("","","",""))



```


```{r Output_panel_oecd_reg_fin, results="asis"}


stargazer(oecd_reg_list,
          header = FALSE, omit.stat = "f",
          title = "OEDC sample",
          dep.var.labels = c("","","",""))



```


```{r Output_panel_weak_reg_fin, results="asis"}


stargazer(weak_reg_list,
          header = FALSE, omit.stat = "f",
          title = "Weak sample (18 Countries)",
          dep.var.labels = c("","","",""))



```


\subsection{Explanatory variables}

Financial openness measure is based on the index of capital account openness or KAOPEN, by Chinn and Ito. KAOPEN is the first standardized principal component of the variables that indicate the presence of multiple exchange rates, restrictions on current account transactions, on capital account transactions, and the requirement of the surrender of export proceeds. The index is normalized between zero and one. Higher values of this index indicate that a country is more open to cross-border capital transactions.

\section{Bibliography}





```{r panel_reg_sens, results="asis", eval=FALSE}

panel_reg_sens = list(synch_1_list$FinRet, synch_1_list$FinCycle, synch_3_list$FinRet, synch_3_list$FinCycle, bank_int$bank_pop, bank_int$bank_gdp) %>% 
  purrr::reduce(full_join, by = c("Date","CountryPair"),
                suffix = c("_synch1","_synch3"))

panel_reg_sens = append.countrypair.dataframe(panel_reg_sens,df %>% 
  select(Date, Country, GDP_per_Capita_real, Pop)) %>% 
  mutate(LGDP = log(GDP_per_Capita_real_A) + log(GDP_per_Capita_real_B)) %>% 
  mutate(LPop = log(Pop_A) * log(Pop_B)) %>% 
  mutate(DGDP = log(GDP_per_Capita_real_A) - log(GDP_per_Capita_real_B)) %>% 
  select(-ends_with("_A")) %>% 
  select(-ends_with("_B"))

dep_vars = paste0(rep(c("FinRet","FinCycle"), each = length(c("_synch1","_synch3"))), c("_synch1","_synch3"))

x_vars = c(paste(c("bank_pop","LGDP","LPop"), collapse = "+"),
           paste(c("bank_gdp","LGDP","LPop"), collapse = "+"))

panel_reg_sens_res = lapply(apply(expand.grid(dep_vars, x_vars),
                                  1,paste, collapse = "~"),
       function(temp_form){plm(formula = formula(temp_form),
                               data = panel_reg_sens,
                               model = "within",
                               effect = "twoways")})


stargazer(panel_reg_sens_res, omit.stat = "f",
          column.labels = rep(gsub("[_,Fin, synch]","",dep_vars),2),
          header = FALSE)

```




```{r params_setup}

countries_list = list(
  kpp_countries = c(
    "Australia",
    "Austria",
    "Belgium",
    "Canada",
    "Switzerland",
    "Germany",
    "Denmark",
    "Spain",
    "Finland",
    "France",
    "United_Kingdom",
    "Ireland",
    "Italy",
    "Japan",
    "Netherlands",
    "Portugal",
    "Sweden",
    "United_States"
  ),
  fsap_countries = c(
    "Austria",
    "Belgium",
    "Germany",
    "Denmark",
    "Spain",
    "France",
    "Finland",
    "Greece",
    "Ireland",
    "Italy",
    "Luxembourg",
    "Netherlands",
    "Portugal",
    "Sweden",
    "United_Kingdom"
  ),
  eu_countries = c(
    "Austria",
    "Belgium",
    "Bulgaria",
    "Croatia",
    "Cyprus",
    "Czech_Republic",
    "Denmark",
    "Estonia",
    "Finland",
    "France",
    "Germany",
    "Greece",
    "Hungary",
    "Ireland",
    "Italy",
    "Latvia",
    "Lithuania",
    "Luxembourg",
    "Malta",
    "Netherlands",
    "Poland",
    "Portugal",
    "Romania",
    "Slovak_Republic",
    "Slovenia",
    "Spain",
    "Sweden",
    "United_Kingdom"
  ),
  euro_countries = c(
    "Austria",
    "Belgium",
    "Cyprus",
    "Estonia",
    "Finland",
    "France",
    "Germany",
    "Greece",
    "Ireland",
    "Italy",
    "Latvia",
    "Lithuania",
    "Luxembourg",
    "Malta",
    "Netherlands",
    "Portugal",
    "Slovak_Republic",
    "Slovenia",
    "Spain"
  )
)


pairs_list = lapply(names(countries_list),
                    function(temp_name){
                      apply(combn(countries_list[[temp_name]],2), 2,
                            function(temp_col){
                              ifelse(temp_col[1]<temp_col[2],
                                     paste(temp_col[1],temp_col[2],sep = "-"),
                                     paste(temp_col[2],temp_col[1],sep = "-"))})

                    })

names(pairs_list) = paste(names(countries_list), "pairs", sep = "_")

countries_list = c(countries_list, pairs_list)

rm(pairs_list)

reg_list = list()



```

```{r import_wdi_df}

wdi_df = import_wdi_df(countries_vec = countries_list$kpp_countries)

wdi_df = wdi_df %>% 
  rename_all(tolower) %>% 
  rename(date = year) %>% 
  mutate(gdp = gdp * 10 ^ (-6))
  


```

```{r import_trade_data}

trade_df = import_imf_trade_data(countries_vec = countries_list$kpp_countries)

trade_df = trade_df %>% 
  ungroup() %>% 
  rename_all(tolower) %>% 
  separate(countrypair,into = c("country", "counterparty_country"),sep = "-") %>% 
  filter(country %in% countries_list$kpp_countries) %>% 
  filter(counterparty_country %in% countries_list$kpp_countries) %>% 
  left_join(select(wdi_df, c(date, country, gdp)), by = c("date","country")) %>% 
  left_join(select(wdi_df, c(date, country, gdp)),
            by = c("date","counterparty_country" = "country")) %>% 
  mutate(trade = trade / (gdp.x + gdp.y)) %>% 
  group_by(date, country,counterparty_country) %>% 
  summarise(trade = log(sum(trade, na.rm = TRUE)), .groups = "drop") %>% 
  mutate(date = as.numeric(date))
            
            


```

```{r import_lbs}

lbs_df = import_bis_lbs(paste0(Sys.getenv("USERPROFILE"),
                               "\\OneDrive - Bank Of Israel",                               "\\Data\\BIS\\WEBSTATS_LBS_D_PUB_DATAFLOW_csv_col.csv"))


lbs_df_filtered = lbs_df %>% 
  filter(reporting_country %in% str_replace_all(countries_list$kpp_countries,
                                                "_"," ")) %>%
  filter(counterparty_country %in% str_replace_all(countries_list$kpp_countries,
                                                   "_"," ")) %>%
  filter(measure == "Amounts outstanding / Stocks") %>% 
  filter(type_of_instruments == "All instruments") %>% 
  filter(currency_denomination == "All currencies") %>% 
  filter(counterparty_sector == "All sectors") %>% 
  select(c(reporting_country, counterparty_country, balance_sheet_position,
           matches("[0-9]"))) %>% 
  mutate(across(c(reporting_country, counterparty_country),
                ~str_replace_all(.," ","_"))) %>% 
  pivot_longer(-c(reporting_country, counterparty_country,
                  balance_sheet_position),
               names_to = "date") %>% 
  mutate(date = year(as.yearqtr(date, format = "%Y-Q%q"))) %>% 
  filter(date >= 1978 & date <= 2006) %>% 
  group_by(reporting_country, counterparty_country,
           balance_sheet_position,date) %>% 
  summarise(value = mean(value, na.rm = TRUE), .groups = "drop") %>% 
  filter(complete.cases(.))






```

```{r bank_integration_data}

bank_int = lbs_df_filtered %>% 
  left_join(wdi_df %>% 
              mutate(date = as.numeric(date)) %>% 
              select(c(date, country, gdp)),
            by = c("date", "reporting_country" = "country")) %>% 
  left_join(wdi_df %>% 
              mutate(date = as.numeric(date)) %>% 
              select(c(date, country, gdp)),
            by = c("date", "counterparty_country" = "country"),
            suffix = c("_x","_y")) %>% 
  mutate(value = log(value / (gdp_x + gdp_y))) %>% 
  select(-starts_with("gdp")) %>% 
  group_by(reporting_country,counterparty_country,date) %>% 
  summarise(bank_int = mean(value, na.rm = TRUE), .groups = "drop") %>% 
  rename(country = reporting_country)

# rm(lbs_df, lbs_df_filtered)

```

```{r synch_data}

gdp_per_capita_df = wdi_df %>% 
  select(date,country, gdp_pc = gdp_per_capita) %>% 
  filter(country %in% countries_list$kpp_countries) %>%
  filter(date >= 1977 & date <= 2006) %>%
  mutate(date = as.numeric(date)) %>%
  arrange(country, date) %>%
  mutate(gdp_pc_lag = dplyr::lag(gdp_pc)) %>%
  filter(complete.cases(.)) %>%
  mutate(across(starts_with("gdp"), as.numeric)) %>%
  mutate(gdp_diff = log(gdp_pc) - log(gdp_pc_lag)) %>%
  select(-starts_with("gdp_pc"))



synch_df = bank_int %>% 
  select(country, counterparty_country, date) %>%
  left_join(gdp_per_capita_df,
            by = c("date", "country" = "country")) %>% 
  left_join(gdp_per_capita_df,
            by = c("date", "counterparty_country" = "country"),
            suffix = c("_x","_y")) %>% 
  mutate(synch = -1 * abs(gdp_diff_x - gdp_diff_y)) %>% 
  select(-starts_with("gdp_diff"))

rm(gdp_per_capita_df)

```

```{r harmon_data}

harmon = import.harmon.data()

harmon = construct_countrypair_harmon_index(harmon)

harmon = harmon %>% 
  group_by(country, counterparty_country, date = year(date)) %>% 
  summarise(fsap_ind = max(fsap_ind, na.rm = TRUE), .groups = "drop")

```

```{r import_fx_regime}

fx_data = read_csv(paste0(
  Sys.getenv("USERPROFILE"),"\\OneDrive - Bank Of Israel\\",
  "Data\\AizenmanChinnIto\\trilemma_indexes_update2018.csv")) %>% 
  select(year, country = `Country Name`,
         fx_regime = `Exchange Rate Stability Index`) %>% 
  mutate(country = str_replace(country, " ", "_"))

fx_data =fx_data %>% 
  filter(country %in% countries_list$kpp_countries)

```

```{r import_eu_data}

eu_data = read_csv(paste0(
  Sys.getenv("USERPROFILE"),"\\OneDrive - Bank Of Israel\\",
  "Data\\Misc\\EU_membership.csv")) %>% 
  rename_all(tolower) %>% 
  rename_all(~str_remove_all(.,"_membership")) %>% 
  mutate(country = str_replace_all(country," ","_")) %>% 
  mutate(country = str_remove(country,"The ")) %>% 
  filter(country %in% countries_list$kpp_countries) %>% 
  mutate(across(matches("^eu"), as.numeric)) %>% 
  pivot_longer(-country,names_to = "membership", values_to = "date") %>% 
  mutate(value = 1) %>% 
  pivot_wider(names_from = membership,values_from = value) %>% 
  mutate(across(matches("eu"), ~replace_na(.,0)))

```



```{r merge_data}

df = list(bank_int, trade_df,synch_df) %>% 
  reduce(inner_join, by = c("date","country","counterparty_country")) %>% 
  left_join(harmon, by = c("date","country","counterparty_country")) %>% 
  mutate(fsap_ind = replace_na(fsap_ind,0))

df = df %>% 
  filter(complete.cases(.)) %>% 
  filter(is.finite(trade))

df = df %>% 
  left_join(fx_data, by = c("country", "date" = "year")) %>% 
  left_join(fx_data, by = c("counterparty_country" = "country",
                            "date" = "year"), suffix = c("_x","_y")) %>% 
  mutate(fx_regime = log(fx_regime_x) + log(fx_regime_x)) %>% 
  select(-matches("_[xy]$"))



df = df %>% 
  left_join(eu_data, by = c("country", "date")) %>% 
  left_join(eu_data, by = c("counterparty_country" = "country",
                            "date"), suffix = c("_x","_y")) %>% 
  mutate(across(matches("eu"), ~replace_na(.,0))) %>% 
  rowwise() %>% 
  mutate(eu_both = sum(eu_x,eu_y)) %>%
  mutate(euro_both = sum(euro_x,euro_y)) %>% 
  select(-matches("_[xy]$")) %>% 
  mutate(euro_alone = as.numeric(euro_both == 1)) %>% 
  mutate(eu_alone = as.numeric(eu_both == 1)) %>% 
  mutate(euro_both = as.numeric(euro_both == 2)) %>% 
  mutate(eu_both = as.numeric(eu_both == 2))


df = df %>% 
  unite(c("country", "counterparty_country"), col = "countrypair")



```


```{r clean_up}

rm(list = ls()[!ls() == "df"])

```


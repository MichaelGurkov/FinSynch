
```{r import_lbs}

lbs_df = import_bis_lbs(paste0("C:\\Users\\internet\\OneDrive - Bank Of Israel",
                               "\\Data\\BIS\\WEBSTATS_LBS_D_PUB_DATAFLOW_csv_col.csv"))


lbs_df_filtered = lbs_df %>% 
  filter(reporting_country %in% str_replace_all(countries_list$kpp_countries,"_"," ")) %>%
  filter(counterparty_country %in% str_replace_all(countries_list$kpp_countries,"_"," ")) %>%
  filter(measure == "Amounts outstanding / Stocks") %>% 
  filter(type_of_instruments == "All instruments") %>% 
  filter(currency_denomination == "All currencies") %>% 
  filter(counterparty_sector == "All sectors") %>% 
  select(c(reporting_country, counterparty_country, balance_sheet_position,
           matches("[0-9]"))) %>% 
  mutate(across(c(reporting_country, counterparty_country),
                ~str_replace_all(.," ","_"))) %>% 
  pivot_longer(-c(reporting_country, counterparty_country, balance_sheet_position),
               names_to = "date") %>% 
  mutate(date = year(as.yearqtr(date, format = "%Y-Q%q"))) %>% 
  filter(date >= 1978 & date <= 2006) %>% 
  group_by(reporting_country, counterparty_country, balance_sheet_position,date) %>% 
  summarise(value = mean(value, na.rm = TRUE), .groups = "drop") %>% 
  filter(complete.cases(.))






```


```{r import_gdp}

gdp_df = read_csv(paste0(Sys.getenv("USERPROFILE"),
                  "\\OneDrive - Bank Of Israel\\Data\\World Bank\\GDP_panel.csv"),
                  col_types = cols()) %>% 
  select(country = `Country Name`, matches("[0-9]")) %>% 
  filter(country %in% countries_list$kpp_countries) %>% 
  pivot_longer(-country,names_to = "date", values_to = "gdp") %>% 
  filter(date >= 1978 & date <= 2006) %>% 
  mutate(date = as.numeric(date)) %>% 
  mutate(gdp = gdp * 10 ^ (-6))


```

```{r import_gdp_per_capita}

gdp_per_capita_df = read_csv(paste0(Sys.getenv("USERPROFILE"),
                  "\\OneDrive - Bank Of Israel\\Data\\World Bank\\GDP_per_capita_panel.csv"),
                  col_types = cols()) %>% 
  select(country = `Country Name`, matches("[0-9]")) %>% 
  filter(country %in% countries_list$kpp_countries) %>% 
  pivot_longer(-country,names_to = "date", values_to = "gdp_pc") %>% 
  mutate(date = str_extract(date,"^[0-9]{4}")) %>% 
  filter(date >= 1977 & date <= 2006) %>% 
  mutate(date = as.numeric(date)) %>% 
  arrange(country, date) %>% 
  mutate(gdp_pc_lag = dplyr::lag(gdp_pc)) %>% 
  filter(complete.cases(.)) %>% 
  mutate(across(starts_with("gdp"), as.numeric)) %>% 
  mutate(gdp_diff = log(gdp_pc) - log(gdp_pc_lag)) %>% 
  select(-starts_with("gdp_pc"))

```


```{r, eval=FALSE}

temp_lbs = import.bis.lbs.data(countries_vec = countries_list$kpp_countries) %>%
  mutate(Date = year(as.yearqtr(Date, format = "%Y-Q%q"))) %>% 
  filter(Date >= 1978 & Date <= 2006) %>%
  group_by(Balance_Pos,CountryPair,Date) %>% 
  summarise(Balance = mean(Balance, na.rm = TRUE), .groups = "drop") %>% 
  filter(complete.cases(.))




```



```{r data}

df = lbs_df_filtered %>% 
  left_join(gdp_df, by = c("date", "reporting_country" = "country")) %>% 
  left_join(gdp_df, by = c("date", "counterparty_country" = "country"),
            suffix = c("_x","_y")) %>% 
  mutate(value = log(value / (gdp_x + gdp_y))) %>% 
  select(-starts_with("gdp")) %>% 
  group_by(reporting_country,counterparty_country,date) %>% 
  summarise(bank_int = mean(value, na.rm = TRUE), .groups = "drop") %>% 
  left_join(gdp_per_capita_df, by = c("date", "reporting_country" = "country")) %>% 
  left_join(gdp_per_capita_df, by = c("date", "counterparty_country" = "country"),
            suffix = c("_x","_y")) %>% 
  mutate(synch = -1 * abs(gdp_diff_x - gdp_diff_y)) %>% 
  select(-starts_with("gdp_diff"))

```



```{r captions_setup}

theme_set(theme_bw())

library(cowplot)

plot_cycles_cap = paste0(
  "This figure plots the financial cycles of the US, UK and Israel",
  " The financial cycle is defined as the simple average of log returns",
  " of the three cycle components (total credit, home prices",
  " and share prices).",
  "\\label{plot_cycles}")

plot_correl_cap = paste0(
 "The figure plots the within-country pair and within-year correlation between",
 " financial synchronization. (Fin Synch) on the vertical axis",
" and banking integration (Bank Linkages) on the horizontal axis.",
" Each observation corresponds to a particular country pair",
" in each year. To generate the figure I first regress output",
" synchronization and banking integration on country-pair fixed",
" effects and year fixed effects. Then the residuals",
" of the synchronization regression on the vertical axis",
" are plotted against the residuals from the banking integration regression",
" on the horizontal axis.",
"\\label{plot_correl}")



plot_bank_linkages_cap = paste0(
  "The cross border credit (USD millions) for top 5 counter-parties of two",
  " big financial centers (United States and United Kingdom), and a small",
  " open market country (Israel).", "\\label{plot_bank_linkages}")


```


```{r make_net_df}

net_df = map(
  c("United_States","United_Kingdom","Israel"),function(temp_country){
  
  temp_df = raw_data$bis_lbs %>%
    filter(grepl(temp_country,CountryPair)) %>%
    filter(Date == as.yearqtr("2018 Q4")) %>% 
    select(CountryPair, Balance) %>%
    group_by(CountryPair) %>%
    summarise(Balance = mean(Balance, na.rm = TRUE) * 10 ^ (-3),
              .groups = "drop") %>%
    mutate(CountryPair = str_remove_all(CountryPair,temp_country)) %>%
    mutate(CountryPair = str_remove_all(CountryPair,"-")) %>%
    mutate(CountryPair = str_replace_all(CountryPair,"_"," ")) %>%
    rename(Country = CountryPair) %>% 
    mutate(Source = temp_country)

}) %>% 
  bind_rows()

```


```{r make_correl_df}

bank_clean = plm(sub("Fin_synch","bank_gdp",
                     gsub("lag(bank_gdp,1) *","",reg_formula_list$full_spec,
                          fixed = TRUE),
                     fixed = TRUE),
                 data = fin_reg_df, index = c("CountryPair","Date"),
                 model = "within", effect = "twoways")

synch_clean = plm(gsub("lag(bank_gdp,1) *","",reg_formula_list$full_spec,
                       fixed = TRUE),
                  data = fin_reg_df, index = c("CountryPair","Date"),
                  model = "within", effect = "twoways")

correl_df = list(bank_clean$model$CountryPair,
                bank_clean$residuals, synch_clean$residuals) %>%
  reduce(cbind.data.frame) %>%
  setNames(c("CountryPair","Bank","FinSynch"))

```


For illustration purpose, This section presents the result of the analysis for two big financial centers (the United States and the United Kingdom), as well as a small open market country (Israel). The distribution of the bilateral cross border credit is shown in Figure \ref{plot_bank_linkages}. The United States and United Kingdom are the largest counterparties to each other, the Unites States is also the largest cross-border credit counterparty for Israel.

```{r plot_bank_linkages,fig.cap=plot_bank_linkages_cap,out.extra=""}

plot_list = map(unique(net_df$Source),function(temp_name){
  
  net_df %>% 
    filter(Source == temp_name) %>% 
    slice_max(Balance,n = 5) %>% 
    ggplot(aes(x = reorder(Country, Balance), y = Balance)) + 
    geom_col(width = 0.3) +
    labs(title = str_replace(temp_name,"_"," ")) + 
    xlab(NULL) + 
    ylab(NULL) + 
    coord_flip() + 
    scale_y_continuous(labels = scales::number_format(accuracy = 1)) + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(size = 7))
  
  
  
})

plot_grid(plotlist = plot_list,ncol = 3)

```



```{r plot_cycles, fig.cap=plot_cycles_cap, out.extra=""}

ggplot(country_df %>% 
  select(Date, Country, Fin_ret) %>% 
  filter(Country %in% c("Israel","United_States",
                        "United_Kingdom")) %>% 
  filter(Date >= 1995),
  aes(x = Date, y = Fin_ret * 100, color = Country,
      group = Country)) + 
  geom_line() + 
  labs(x = "", y = "Rate of change (YoY)",
       title = paste0("Financial cycles of the US, UK and Israel")) + 
  theme_bw() + 
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45,
                                   vjust = 0.5))
  

```



Figure \ref{plot_correl} shows the correlation between financial
synchronization and banking integration for United Kingdom-United States and Israel-United States pairs. To obtain the correlation estimate I first regress financial
synchronization and banking integration on a control variables set (including
fixed effect) in an attempt to "clean out" the effect of other factors.
The figure plots the residuals of these first step regressions, the trend line shows the (slightly) negative association between financial synchronization and banking integration in the all country pair.

```{r plot_correl,fig.cap=plot_correl_cap, out.extra=""}

correl_df %>%
  filter(CountryPair %in% c("Israel-United_States",
                            "United_Kingdom-United_States")) %>% 
  mutate(CountryPair = str_replace_all(CountryPair,"_"," ")) %>% 
  ggplot(aes(x = Bank, y = FinSynch)) +
  geom_point() +
  labs(x = "Banking integration (log of bank credit to gdp)",
       y = "Financial synchronization (percent)",
       title = paste("Correlation of banking integration and",
       "financial synchronization \n (netting fixed effects and controls)")) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~CountryPair) + 
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

```

The effect of banking linkages in the Israel subsample is similar to the effect in the total sample. A one standard deviation change in banking linkages reduces the synchronization by `r abs(round(coef_vec[names(coef_vec) == "lag(bank_gdp, 1)"] * sd_ratio_isr,2))` standard deviations.



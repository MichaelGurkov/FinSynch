
```{r captions_setup}

theme_set(theme_bw())

library(cowplot)

plot_correl_cap = paste0("Correlation of banking integration and ",
                            "financial synchronization ",
                            "(netting fixed effects and controls).",
                            " \\label{plot_israel_us}")


plot_bank_linkages_cap = paste0(
  "Top 5 counter parties with respect to cross border credit",
  " \\label{plot_bank_linkages}")
```


```{r make_net_df}

net_df = map(
  c("United_States","United_Kingdom","Israel"),function(temp_country){
  
  temp_df = raw_data$bis_lbs %>%
    filter(grepl(temp_country,CountryPair)) %>%
    filter(Date == as.yearqtr("2018 Q4")) %>% 
    select(CountryPair, Balance) %>%
    group_by(CountryPair) %>%
    summarise(Balance = mean(Balance, na.rm = TRUE) * 10 ^ (-3),
              .groups = "drop") %>%
    mutate(CountryPair = str_remove_all(CountryPair,temp_country)) %>%
    mutate(CountryPair = str_remove_all(CountryPair,"-")) %>%
    mutate(CountryPair = str_replace_all(CountryPair,"_"," ")) %>%
    rename(Country = CountryPair) %>% 
    mutate(Source = temp_country)

}) %>% 
  bind_rows()

```


```{r make_correl_df}

bank_clean = plm(sub("Fin_synch","bank_gdp",
                     gsub("lag(bank_gdp,1) *","",reg_formula, fixed = TRUE),
                     fixed = TRUE),
                 data = fin_reg_df, index = c("CountryPair","Date"),
                 model = "within", effect = "twoways")

synch_clean = plm(gsub("lag(bank_gdp,1) *","",reg_formula, fixed = TRUE),
                  data = fin_reg_df, index = c("CountryPair","Date"),
                  model = "within", effect = "twoways")

correl_df = list(bank_clean$model$CountryPair,
                bank_clean$residuals, synch_clean$residuals) %>%
  reduce(cbind.data.frame) %>%
  setNames(c("CountryPair","Bank","FinSynch"))

```


For illustration purpose, I present in this section the result of the analysis
for two big financial centers (United States and United Kingdom), as well as small open market country (Israel).The distribution of the bilateral cross border credit is shown in figure \ref{plot_bank_linkages}. Interestingly United States and United Kingdom are the largest counterparty to each other, Unites States is also the largest cross border credit counterparty for Israel.

```{r plot_bank_linkages,fig.cap=plot_bank_linkages_cap, fig.pos="h", out.extra=""}

plot_list = map(unique(net_df$Source),function(temp_name){
  
  net_df %>% 
    filter(Source == temp_name) %>% 
    slice_max(Balance,n = 5) %>% 
    ggplot(aes(x = reorder(Country, Balance), y = Balance)) + 
    geom_col(width = 0.3) +
    labs(title = str_replace(temp_name,"_"," ")) + 
    xlab(NULL) + 
    ylab(NULL) + 
    coord_flip() + 
    scale_y_continuous(labels = scales::number_format(accuracy = 1)) + 
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(size = 7))
  
  
  
})

plot_grid(plotlist = plot_list,ncol = 3)

```



```{r plot_cycles, fig.cap="Financial cycles of US, UK and Israel\\label{plot_cycles}", fig.pos="h", out.extra=""}

ggplot(country_df %>% 
  select(Date, Country, Fin_ret) %>% 
  filter(Country %in% c("Israel","United_States",
                        "United_Kingdom")) %>% 
  filter(Date >= 1995),
  aes(x = Date, y = Fin_ret * 100, color = Country,
      group = Country)) + 
  geom_line() + 
  labs(x = "", y = "Rate of change (YoY)",
       title = paste0("Synchronization of Israel and",
                      " US financial activity")) + 
  theme_bw() + 
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45,
                                   vjust = 0.5))
  

```



Figure \ref{plot_correl} shows the correlation between financial
synchronization and banking integration for United Kingdom - United States and Israel - United States pairs. To control for the effect of other factors I first regress financial
synchronization and banking integration on control variables set (including
fixed effect). The figure plots the residuals of this first step regressions, the trend line shows the (slightly) negative association between financial synchronization and banking integration in the all country pair.

```{r plot_correl,fig.cap="plot_correl_cap\\label{plot_correl}", fig.pos="H", out.extra=""}


ggplot(correl_df %>%
         filter(CountryPair %in% c("Israel-United_States",
                                   "United_Kingdom-United_States")),
       aes(x = Bank, y = FinSynch)) +
  geom_point() +
  labs(x = "Banking integration (log of bank credit to gdp)",
       y = "Financial synchronization (percent)",
       title = paste("Correlation of banking integration and",
       "financial synchronization \n (netting fixed effects and controls)")) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~CountryPair) + 
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

```

The effect of banking linkages in Israel sub sample is similar to the effect in the total sample. A one standard deviation change in banking linkages reduces the synchronization by `r abs(round(coef_vec[names(coef_vec) == "lag(bank_gdp, 1)"] * sd_ratio_isr,2))` standard deviations.



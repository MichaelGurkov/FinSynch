```{r define_fig_captions}

country_pairs = length(unique(country_pair_df$country_pair))

countries = map(c("gdp_constant","trilemma_ind"),
                function(temp_name){
                  
                  temp_col = raw_data %>%
                    pluck(temp_name) %>%
                    select(country) %>%
                    distinct()
                  
                  return(temp_col)
                  
                }) %>%
  reduce(inner_join, by = "country") %>%
  nrow()

bank_gdp_cap = paste0(
  "Cross-border bank claims over time. ",
  "This figure plots the dynamics of the average value of ",
  "logs of bilateral stocks of assets and liabilities normalized",
  " by the sum of the two countriesâ€™ GDP.",
  " For each year, the average is estimated across ",
  country_pairs,
  " country pairs (the sample spans ",countries,
  " countries).",
  
  " Shaded areas are banking crisis periods.",
  " \\label{plot_bank_gdp}"
)


avg_cycle_synch_cap = paste0(
  "Financial cycle synchronization over time.",
  " This figure plots the evolution of the average value of ",
  "the negative absolute difference in financial cycle rate of change",
  " between country i and country j in year t.",
  " For each year, the average is estimated across ",
  country_pairs,
  " country pairs (the sample spans ",countries,
  " countries).",
  " \\label{plot_Fin_synch}")

```


Summary statistics of the data are presented in Table \ref{summary_table}.
The sample includes `r format(nrow(country_pair_df),big.mark = ",")` country pair-year observations for `r paste(range(country_pair_df$year), collapse = " - ")` period. The average divergence in financial cycle growth over the sample period is `r round(mean(country_pair_df$fin_synch, na.rm = TRUE),2)` (Fin cycles synch), with significant variation (the standard deviation is `r round(sd(country_pair_df$fin_synch, na.rm = TRUE),2)`). Banking linkages are characterized by similar average level (`r round(mean(country_pair_df$bank_gdp),2)`) with much smaller variation (the standard deviation is `r round(sd(country_pair_df$bank_gdp),2)`).
About `r format(mean(country_pair_df$crisis_ind) * 100,digits = 3)` percent of the observations in the sample refer to crisis periods (where at least one country in the country pair undergoes a financial crisis during this year).

```{r countrypair_table_summary, include=FALSE}

desc_df = country_pair_df %>%
  rename(`Financial synchronization` = fin_synch,
         `Banking linkages` = bank_gdp,
         Crises = crisis_ind,
         FD = fd_ind,
         `Trade linkages` = trade_gdp,
         `FX stability` = fx_stab,
         `Financial openness` = fo_ind,
         `GDP total` = gdp_usd) %>%
  as.data.frame()

star = stargazer(desc_df,
                 title = "Summary statistics of the main variables",
                 label = "summary_table",
                 header = FALSE,
                 summary = TRUE,
                 digits = 2,
                 digits.extra = 0,
                 summary.stat = c("max", "min", "mean", "median", "sd", "n"),
                 notes = paste0(
                   "\\parbox[t]{16cm}{",
                   paste0(
                     "Note: The table reports summary statistics of ",
                     "the main variables used in the empirical ",
                     "analysis.",
                     notes_str ,
                     "}"
                   )
                 )
)

star = star %>%
  sub(pattern = "Fin\\_synch",replacement = "Fin cycles synch",
      fixed = TRUE) %>%
  sub(pattern = "bank\\_gdp",replacement = "Banking linkages",
      fixed = TRUE) %>%
  sub(pattern = "FD\\_tot",replacement = "Financial development",
      fixed = TRUE) %>%
  sub(pattern = "Crises\\_tot",replacement = "Crises",
      fixed = TRUE) %>%
  sub(pattern = "Euro\\_both",replacement = "Euro",
      fixed = TRUE) %>%
  sub(pattern = "0.00",replacement = "0",
      fixed = TRUE)


# star = sub("Fin\\_synch","Fin cycles synch",star,fixed = TRUE)
#
# star = sub("bank\\_gdp","Banking linkages",star,fixed = TRUE)
#
# star = sub("FD\\_tot","Financial development",star,fixed = TRUE)



```


```{r output_summary_table, results="asis"}

cat(star, sep = "\n")

```


Figure \ref{plot_bank_gdp} shows the average cross-border (bilateral) bank linkages of the countries in my sample. We can see that financial integration had increased since the 1980s until 2007 - 2008 (the Global Financial Crisis)  and then a sharp decline followed. The shaded area in the figure refer to the dates of banking crises (which comes from an updated version of @Laeven2013 and includes the start and end year of banking crises in the OECD countries for the entire sample period) in the sample countries and it seems that those are associated with a decrease in financial integration.


```{r plot_bank_gdp,fig.cap=bank_gdp_cap,fig.height=5}

bank_plot_df = country_pair_df %>%
  select(year, bank_gdp) %>%
  group_by(year) %>%
  summarise(avg_bank = mean(bank_gdp,
                            na.rm = TRUE),
            .groups = "drop") %>%
  filter(complete.cases(.))

ggplot() +
  labs(title = "Average bank linkages \n (real, normalized by gdp)",
       y = "", x = "") +
  geom_line(data = bank_plot_df,
            mapping = aes(x = year, y = avg_bank, group = 1)) +
  geom_rect(data = raw_data$crises_df,
            mapping = aes(xmin = start_year,xmax = end_year,
                          ymin = -Inf, ymax = Inf),
            fill = "lightgray", alpha = 0.1) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0,size = 7),
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        axis.title.x = element_blank())

rm(bank_plot_df)

```


```{r plot_average_cycle_synch,fig.cap=avg_cycle_synch_cap,fig.pos="H"}

ggplot(country_pair_df %>%
         select(year, fin_synch) %>%
         group_by(year) %>%
         summarise(avg_fin_synch = mean(fin_synch, na.rm = TRUE),
                   .groups = "drop") %>%
         filter(complete.cases(.)) %>%
         filter(is.finite(avg_fin_synch)),
       aes(x = year, y = avg_fin_synch, group = 1)) +
  labs(title = "Average financial cycle synchronization",y = "", x = "") +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0, size = 7),
        legend.position = "bottom", plot.title = element_text(hjust = 0.5))


```


Figure \ref{plot_Fin_synch} shows the average synchronization (measured as the difference between credit and home price growth rates for each country pair). The synchronization seems to be quite volatile with no specific trend until 2007 - 2008 (the Great Financial Crisis) and trending upward since.


